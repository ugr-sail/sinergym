<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sinergym with Google Cloud &mdash; sinergym  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/logo-sidebar.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API reference" href="API-reference.html" />
    <link rel="prev" title="Deep Reinforcement Learning Integration" href="deep-reinforcement-learning.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #a9c1be" >
            <a href="../index.html" class="icon icon-home"> sinergym
            <img src="../_static/logo-sidebar.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="environments.html">Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="github-actions.html">Github Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="tests.html">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage-example.html">Usage example</a></li>
<li class="toctree-l1"><a class="reference internal" href="extra-configuration.html">Extra Configuration in Sinergym simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="output.html">Output format</a></li>
<li class="toctree-l1"><a class="reference internal" href="rewards.html">Rewards</a></li>
<li class="toctree-l1"><a class="reference internal" href="controllers.html">Controllers</a></li>
<li class="toctree-l1"><a class="reference internal" href="wrappers.html">Wrappers</a></li>
<li class="toctree-l1"><a class="reference internal" href="deep-reinforcement-learning.html">Deep Reinforcement Learning Integration</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Sinergym with Google Cloud</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#preparing-google-cloud">Preparing Google Cloud</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#first-steps-configuration">1. First steps (configuration)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#use-our-container-in-google-cloud-platform">2. Use our container in Google Cloud Platform</a></li>
<li class="toctree-l3"><a class="reference internal" href="#use-your-own-container">3. Use your own container</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-your-vm-or-mig">4. Create your VM or MIG</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initiate-your-vm">5. Initiate your VM</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#executing-experiments-in-remote-containers">Executing experiments in remote containers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#containers-permission-to-bucket-storage-output">Containers permission to bucket storage output</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#remote-tensorboard-log">Remote Tensorboard log</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#visualize-remote-tensorboard-log-in-real-time">Visualize remote Tensorboard log in real-time</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#mlflow-tracking-server-set-up">Mlflow tracking server set up</a></li>
<li class="toctree-l2"><a class="reference internal" href="#google-cloud-alerts">Google Cloud Alerts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="API-reference.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #a9c1be" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">sinergym</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Sinergym with Google Cloud</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/pages/gcloudAPI.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sinergym-with-google-cloud">
<h1>Sinergym with Google Cloud<a class="headerlink" href="#sinergym-with-google-cloud" title="Permalink to this headline"></a></h1>
<p>In this project, we have defined some functionality based in gcloud API python in <cite>sinergym/utils/gcloud.py</cite>. Our time aim to configure a Google Cloud account and combine with Sinergym easily.</p>
<p>The main idea is to construct a <strong>virtual machine</strong> (VM) using <strong>Google Cloud Engine</strong> (GCE) in order to execute our <strong>Sinergym container</strong> on it. At the same time, this remote container will update a Google Cloud Bucket with experiments results and mlflow tracking server with artifacts if we configure that experiment with those options.</p>
<p>When an instance has finished its job, container <strong>auto-remove</strong> its host instance from Google Cloud Platform if experiments has been configured with this option.</p>
<p>Let’s see a detailed explanation above.</p>
<section id="preparing-google-cloud">
<h2>Preparing Google Cloud<a class="headerlink" href="#preparing-google-cloud" title="Permalink to this headline"></a></h2>
<section id="first-steps-configuration">
<h3>1. First steps (configuration)<a class="headerlink" href="#first-steps-configuration" title="Permalink to this headline"></a></h3>
<p>Firstly, it is necessary that you have a Google Cloud account set up and SDK configured (auth, invoicing, project ID, etc). If you don't have this, it is recommended to check <a class="reference external" href="https://cloud.google.com/sdk/docs/install">their documentation</a>.
Secondly, It is important to have installed <a class="reference external" href="https://www.docker.com/">Docker</a> in order to be able to manage these containers in Google Cloud.</p>
<p>You can link <strong>gcloud</strong> with <strong>docker</strong> accounts using the next (see <a class="reference external" href="https://cloud.google.com/container-registry/docs/advanced-authentication">authentication methods</a>):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ gcloud auth configure-docker
</pre></div>
</div>
<p>If you don't want to have several problems in the future with the image build and Google Cloud functionality in general, we recommend you to <strong>allow permissions for google cloud build</strong> at the beginning (see <a class="reference external" href="https://cloud.google.com/build/docs/securing-builds/configure-access-for-cloud-build-service-account">this documentation</a>).</p>
<a class="reference internal image-reference" href="../_images/service-account-permissions.png"><img alt="Permissions required for cloud build." class="align-center" src="../_images/service-account-permissions.png" style="width: 500px;" /></a>
<p>On the other hand, we are going to enable <strong>Google Cloud services</strong> in <em>API library</em>. These are API's which we need currently:</p>
<blockquote>
<div><ul class="simple">
<li><p>Google Container Registry API.</p></li>
<li><p>Artifact Registry API</p></li>
<li><p>Cloud Run API</p></li>
<li><p>Compute Engine API</p></li>
<li><p>Cloud Logging API</p></li>
<li><p>Cloud Monitoring API</p></li>
<li><p>Cloud Functions API</p></li>
<li><p>Cloud Pub/Sub API</p></li>
<li><p>Cloud SQL Admin API</p></li>
<li><p>Cloud Firestore API</p></li>
<li><p>Cloud Datastore API</p></li>
<li><p>Service Usage API</p></li>
<li><p>Cloud storage</p></li>
<li><p>Gmail API</p></li>
</ul>
</div></blockquote>
<p>Hence, you will have to allow this services into your <strong>Google account</strong>.
You can do it using <strong>gcloud client SDK</strong>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ gcloud services list
$ gcloud services <span class="nb">enable</span> artifactregistry.googleapis.com <span class="se">\</span>
                         cloudapis.googleapis.com <span class="se">\</span>
                         cloudbuild.googleapis.com <span class="se">\</span>
                         containerregistry.googleapis.com <span class="se">\</span>
                         gmail.googleapis.com <span class="se">\</span>
                         sql-component.googleapis.com <span class="se">\</span>
                         sqladmin.googleapis.com <span class="se">\</span>
                         storage-component.googleapis.com <span class="se">\</span>
                         storage.googleapis.com <span class="se">\</span>
                         cloudfunctions.googleapis.com <span class="se">\</span>
                         pubsub.googleapis.com <span class="se">\</span>
                         run.googleapis.com <span class="se">\</span>
                         serviceusage.googleapis.com <span class="se">\</span>
                         drive.googleapis.com <span class="se">\</span>
                         appengine.googleapis.com
</pre></div>
</div>
<p>Or you can use <strong>Google Cloud Platform Console</strong>:</p>
<a class="reference internal image-reference" href="../_images/service-account-APIs.png"><img alt="API's required for cloud build." class="align-center" src="../_images/service-account-APIs.png" style="width: 800px;" /></a>
<p>If you have installed <em>Sinergym</em> and <em>Sinergym extras</em>. <strong>Google Cloud SDK must be linked with other python modules</strong> in order to some functionality works in the future (for example, tensorboard). Please, execute the next in your terminal:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ gcloud auth application-default login
</pre></div>
</div>
</section>
<section id="use-our-container-in-google-cloud-platform">
<h3>2. Use our container in Google Cloud Platform<a class="headerlink" href="#use-our-container-in-google-cloud-platform" title="Permalink to this headline"></a></h3>
<p>Our Sinergym container is uploaded in <strong>Container Registry</strong> as a public one currently. You can use it <strong>locally</strong>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ docker run -it gcr.io/sinergym/sinergym:latest
</pre></div>
</div>
<p>If you want to use it in a <strong>GCE VM</strong>, you can execute the next:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ gcloud compute instances create-with-container sinergym <span class="se">\</span>
    --container-image gcr.io/sinergym/sinergym <span class="se">\</span>
    --zone europe-west1-b <span class="se">\</span>
    --container-privileged <span class="se">\</span>
    --container-restart-policy never <span class="se">\</span>
    --container-stdin <span class="se">\</span>
    --container-tty <span class="se">\</span>
    --boot-disk-size 20GB <span class="se">\</span>
    --boot-disk-type pd-ssd <span class="se">\</span>
    --machine-type n2-highcpu-8
</pre></div>
</div>
<p>We have available containers in Docker Hub too. Please, visit our <a class="reference external" href="https://hub.docker.com/repository/docker/alejandrocn7/sinergym">repository</a></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is possible to change parameters in order to set up your own VM with your preferences (see <a class="reference external" href="https://cloud.google.com/sdk/gcloud/reference/compute/instances/create-with-container">create-with-container</a>).</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><code class="docutils literal notranslate"><span class="pre">--boot-disk-size</span></code> is really important, by default VM set 10GB and it isn't enough at all for Sinergym container.
This derive in a silence error for Google Cloud Build (and you would need to check logs, which incident is not clear).</p>
</div>
</section>
<section id="use-your-own-container">
<h3>3. Use your own container<a class="headerlink" href="#use-your-own-container" title="Permalink to this headline"></a></h3>
<p>Suppose you have this repository forked and you want to upload <strong>your own container on Google Cloud</strong> and to use it. You can use <strong>cloudbuild.yaml</strong>
with our <strong>Dockerfile</strong> for this purpose:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">steps</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="c1"># Write in cache for quick updates</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gcr.io/google.com/cloudsdktool/cloud-sdk&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;bash&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;-c&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;docker</span><span class="nv"> </span><span class="s">pull</span><span class="nv"> </span><span class="s">gcr.io/${PROJECT_ID}/sinergym:latest</span><span class="nv"> </span><span class="s">||</span><span class="nv"> </span><span class="s">exit</span><span class="nv"> </span><span class="s">0&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="c1"># Build image (using cache if it&#39;s possible)</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gcr.io/google.com/cloudsdktool/cloud-sdk&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;docker&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">[</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;build&quot;</span><span class="p p-Indicator">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;-t&quot;</span><span class="p p-Indicator">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;gcr.io/${PROJECT_ID}/sinergym:latest&quot;</span><span class="p p-Indicator">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;--cache-from&quot;</span><span class="p p-Indicator">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;gcr.io/${PROJECT_ID}/sinergym:latest&quot;</span><span class="p p-Indicator">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;--build-arg&quot;</span><span class="p p-Indicator">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;SINERGYM_EXTRAS=[DRL,gcloud]&quot;</span><span class="p p-Indicator">,</span><span class="w"></span>
<span class="w">        </span><span class="s">&quot;.&quot;</span><span class="p p-Indicator">,</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Push image built to container registry</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;gcr.io/google.com/cloudsdktool/cloud-sdk&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;docker&quot;</span><span class="w"></span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;push&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;gcr.io/${PROJECT_ID}/sinergym:latest&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># This container is going to be public (Change command in other case)</span><span class="w"></span>
<span class="w">  </span><span class="c1"># - name: &quot;gcr.io/cloud-builders/gsutil&quot;</span><span class="w"></span>
<span class="w">  </span><span class="c1">#   args:</span><span class="w"></span>
<span class="w">  </span><span class="c1">#     [</span><span class="w"></span>
<span class="w">  </span><span class="c1">#       &quot;iam&quot;,</span><span class="w"></span>
<span class="w">  </span><span class="c1">#       &quot;ch&quot;,</span><span class="w"></span>
<span class="w">  </span><span class="c1">#       &quot;AllUsers:objectViewer&quot;,</span><span class="w"></span>
<span class="w">  </span><span class="c1">#       &quot;gs://artifacts.${PROJECT_ID}.appspot.com&quot;,</span><span class="w"></span>
<span class="w">  </span><span class="c1">#     ]</span><span class="w"></span>
<span class="c1">#Other options for execute build (not container)</span><span class="w"></span>
<span class="nt">options</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">diskSizeGb</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">machineType</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;E2_HIGHCPU_8&quot;</span><span class="w"></span>
<span class="nt">timeout</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">86400s</span><span class="w"></span>
<span class="nt">images</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;gcr.io/${PROJECT_ID}/sinergym:latest&quot;</span><span class="p p-Indicator">]</span><span class="w"></span>
</pre></div>
</div>
<p>This file does the next:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Write in <strong>cache</strong> for quick updates (if a older container was uploaded already).</p></li>
<li><p><strong>Build</strong> image (using cache if it's available)</p></li>
<li><p><strong>Push</strong> image built to Container Registry</p></li>
<li><p>Make container public inner Container Registry.</p></li>
</ol>
</div></blockquote>
<p>There is an option section at the end of the file. Do not confuse this part with the virtual machine configuration.
Google Cloud uses a helper VM to build everything mentioned above. At the same time, we are using this YAML file in order to
upgrade our container because of <em>PROJECT_ID</em> environment variable is defined by Google Cloud SDK, so its value is your current
project in Google Cloud global configuration.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>In the same way VM needs more memory, Google Cloud Build needs at least 10GB to work correctly. In other case it may fail.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If your local computer doesn't have enough free space it might report the same error (there isn't difference by Google cloud error manager),
so be careful.</p>
</div>
<p>In order to execute <strong>cloudbuild.yaml</strong>, you have to do the next:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ gcloud builds submit <span class="se">\</span>
    --config ./cloudbuild.yaml .
</pre></div>
</div>
<p><em>--substitutions</em> can be used in order to configure build parameters if they are needed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>&quot;.&quot; in <code class="docutils literal notranslate"><span class="pre">--config</span></code> refers to <strong>Dockerfile</strong>, which is necessary to build container image (see <a class="reference external" href="https://cloud.google.com/build/docs/build-config">build-config</a>).</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In <strong>cloudbuild.yaml</strong> there is a variable named <em>PROJECT_ID</em>. However, it is not defined in substitutions. This is because it's a predetermined
variable by Google Cloud. When build begins <em>&quot;$PROJECT_ID&quot;</em> is set to current value in gcloud configuration (see <a class="reference external" href="https://cloud.google.com/build/docs/configuring-builds/substitute-variable-values">substitutions-variables</a>).</p>
</div>
</section>
<section id="create-your-vm-or-mig">
<h3>4. Create your VM or MIG<a class="headerlink" href="#create-your-vm-or-mig" title="Permalink to this headline"></a></h3>
<p>To create a <strong>VM</strong> that uses this container, here there is an example:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ gcloud compute instances create-with-container sinergym <span class="se">\</span>
    --container-image gcr.io/sinergym/sinergym <span class="se">\</span>
    --zone europe-west1-b <span class="se">\</span>
    --container-privileged <span class="se">\</span>
    --container-restart-policy never <span class="se">\</span>
    --container-stdin <span class="se">\</span>
    --container-tty <span class="se">\</span>
    --boot-disk-size 20GB <span class="se">\</span>
    --boot-disk-type pd-ssd <span class="se">\</span>
    --machine-type n2-highcpu-8
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">--container-restart-policy</span> <span class="pre">never</span></code> it's really important for a correct functionality.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you decide enter in VM after create it immediately, it is possible container hasn't been created yet.
You can think that is an error, Google cloud should notify this. If this issue happens, you should wait for a several minutes.</p>
</div>
<p>To create a <strong>MIG</strong>, you need to create a machine set up <strong>template</strong> firstly, for example:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ gcloud compute instance-templates create-with-container sinergym-template <span class="se">\</span>
--container-image gcr.io/sinergym/sinergym <span class="se">\</span>
--container-privileged <span class="se">\</span>
--service-account storage-account@sinergym.iam.gserviceaccount.com <span class="se">\</span>
--scopes https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/devstorage.full_control <span class="se">\</span>
--container-env<span class="o">=</span><span class="nv">gce_zone</span><span class="o">=</span>europe-west1-b,gce_project_id<span class="o">=</span>sinergym,MLFLOW_TRACKING_URI<span class="o">=</span>http://<span class="k">$(</span>gcloud compute addresses describe mlflow-ip --format<span class="o">=</span><span class="s1">&#39;get(address)&#39;</span><span class="k">)</span>:5000 <span class="se">\</span>
--container-restart-policy never <span class="se">\</span>
--container-stdin <span class="se">\</span>
--container-tty <span class="se">\</span>
--boot-disk-size 20GB <span class="se">\</span>
--boot-disk-type pd-ssd <span class="se">\</span>
--machine-type n2-highcpu-8
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">--service-account</span></code>, <code class="docutils literal notranslate"><span class="pre">--scopes</span></code> and <code class="docutils literal notranslate"><span class="pre">--container-env</span></code> parameters will be explained in <a class="reference internal" href="#containers-permission-to-bucket-storage-output"><span class="std std-ref">Containers permission to bucket storage output</span></a>. Please, read that documentation before using these parameters, since they require a previous configuration.</p>
</div>
<p>Then, you can create a group-instances as large as you want:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ gcloud compute instance-groups managed create example-group <span class="se">\</span>
    --base-instance-name sinergym-vm <span class="se">\</span>
    --size <span class="m">3</span> <span class="se">\</span>
    --template sinergym-template
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is possible that quote doesn't let you have more than one VM at the same time. Hence, the rest of VM's probably will be <em>initializing</em> always but never ready. If it is your case, we recommend you check your quotes <a class="reference external" href="https://console.cloud.google.com/iam-admin/quotas">here</a></p>
</div>
</section>
<section id="initiate-your-vm">
<h3>5. Initiate your VM<a class="headerlink" href="#initiate-your-vm" title="Permalink to this headline"></a></h3>
<p>Your virtual machine is ready! To connect you can use ssh (see <a class="reference external" href="https://cloud.google.com/sdk/gcloud/reference/compute/ssh">gcloud-ssh</a>):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ gcloud compute ssh &lt;machine-name&gt;
</pre></div>
</div>
<p>Google Cloud use a <strong>Container-Optimized OS</strong> (see <a class="reference external" href="https://cloud.google.com/container-optimized-os/docs">documentation</a>) in VM. This SO have docker pre-installed with sinergym container.</p>
<a class="reference internal image-reference" href="../_images/container1.png"><img alt="GCE VM containers list" class="align-center" src="../_images/container1.png" style="width: 800px;" /></a>
<p>To use this container in our machine you only have to do:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ docker attach &lt;container-name-or-ID&gt;
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/container2.png"><img alt="GCE VM container usage." class="align-center" src="../_images/container2.png" style="width: 800px;" /></a>
<p>And now you can execute your own experiments in Google Cloud! For example, you can enter in remote container with <em>gcloud ssh</em> and execute <em>DRL_battery.py</em> for the experiment you want.</p>
</section>
</section>
<section id="executing-experiments-in-remote-containers">
<h2>Executing experiments in remote containers<a class="headerlink" href="#executing-experiments-in-remote-containers" title="Permalink to this headline"></a></h2>
<p>This script, called <em>DRL_battery.py</em>, will be allocated in every remote container and it is used to execute experiments and combine it with <strong>Google Cloud Bucket</strong>, <strong>Mlflow Artifacts</strong>, <strong>auto-remove</strong>, etc:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">stable_baselines3</span> <span class="kn">import</span> <span class="n">A2C</span><span class="p">,</span> <span class="n">DDPG</span><span class="p">,</span> <span class="n">DQN</span><span class="p">,</span> <span class="n">PPO</span><span class="p">,</span> <span class="n">SAC</span><span class="p">,</span> <span class="n">TD3</span>
<span class="kn">from</span> <span class="nn">stable_baselines3.common.callbacks</span> <span class="kn">import</span> <span class="n">CallbackList</span>
<span class="kn">from</span> <span class="nn">stable_baselines3.common.logger</span> <span class="kn">import</span> <span class="n">configure</span>
<span class="kn">from</span> <span class="nn">stable_baselines3.common.noise</span> <span class="kn">import</span> <span class="n">NormalActionNoise</span>
<span class="kn">from</span> <span class="nn">stable_baselines3.common.vec_env</span> <span class="kn">import</span> <span class="n">DummyVecEnv</span>

<span class="kn">import</span> <span class="nn">sinergym</span>
<span class="kn">import</span> <span class="nn">sinergym.utils.gcloud</span> <span class="k">as</span> <span class="nn">gcloud</span>
<span class="kn">from</span> <span class="nn">sinergym.utils.callbacks</span> <span class="kn">import</span> <span class="n">LoggerCallback</span><span class="p">,</span> <span class="n">LoggerEvalCallback</span>
<span class="kn">from</span> <span class="nn">sinergym.utils.common</span> <span class="kn">import</span> <span class="n">RANGES_5ZONE</span><span class="p">,</span> <span class="n">RANGES_DATACENTER</span><span class="p">,</span> <span class="n">RANGES_IW</span>
<span class="kn">from</span> <span class="nn">sinergym.utils.rewards</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">sinergym.utils.wrappers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">LoggerWrapper</span><span class="p">,</span> <span class="n">MultiObsWrapper</span><span class="p">,</span>
                                     <span class="n">NormalizeObservation</span><span class="p">)</span>

<span class="c1">#--------------------------------BATTERY ARGUMENTS DEFINITION---------------------------------#</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="c1"># commons arguments for battery</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--environment&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-env&#39;</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;environment&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Environment name of simulation (see sinergym/__init__.py).&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--episodes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-ep&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;episodes&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Number of episodes for training.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--algorithm&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-alg&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;PPO&#39;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;algorithm&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Algorithm used to train (possible values: PPO, A2C, DQN, DDPG, SAC, TD3).&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--reward&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-rw&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;reward&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Reward function used by model, by default is linear (possible values: linear, exponential).&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--normalization&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-norm&#39;</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;normalization&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Apply normalization to observations if this flag is specified.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--multiobs&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-mobs&#39;</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;multiobs&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Apply Multi observations if this flag is specified.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--logger&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-log&#39;</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;logger&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Apply Sinergym CSVLogger class if this flag is specified.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--tensorboard&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-tens&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;tensorboard&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Tensorboard path for logging (if not specified, tensorboard log will not be stored).&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--evaluation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-eval&#39;</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;evaluation&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Evaluation is processed during training with this flag (save best model online).&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--eval_freq&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-evalf&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;eval_freq&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Episodes executed before applying evaluation (if evaluation flag is not specified, this value is useless).&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--eval_length&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-evall&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;eval_length&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Episodes executed during evaluation (if evaluation flag is not specified, this value is useless).&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--log_interval&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-inter&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;log_interval&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;model training log_interval parameter. See documentation since this value is different in every algorithm.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--seed&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-sd&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
    <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Seed used to algorithm training.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--remote_store&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-sto&#39;</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;remote_store&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Determine if sinergym output will be sent to a Google Cloud Storage Bucket.&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--mlflow_store&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-mlflow&#39;</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;mlflow_store&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Determine if sinergym output will be sent to a mlflow artifact storage&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--group_name&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-group&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;group_name&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;This field indicate instance group name&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
    <span class="s1">&#39;--auto_delete&#39;</span><span class="p">,</span>
    <span class="s1">&#39;-del&#39;</span><span class="p">,</span>
    <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
    <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;auto_delete&#39;</span><span class="p">,</span>
    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If is a GCE instance and this flag is active, that instance will be removed from GCP.&#39;</span><span class="p">)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--learning_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;-lr&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">.0007</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--gamma&#39;</span><span class="p">,</span> <span class="s1">&#39;-g&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">.99</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--n_steps&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--gae_lambda&#39;</span><span class="p">,</span> <span class="s1">&#39;-gl&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--ent_coef&#39;</span><span class="p">,</span> <span class="s1">&#39;-ec&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--vf_coef&#39;</span><span class="p">,</span> <span class="s1">&#39;-v&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--max_grad_norm&#39;</span><span class="p">,</span> <span class="s1">&#39;-m&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--rms_prop_eps&#39;</span><span class="p">,</span> <span class="s1">&#39;-rms&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--buffer_size&#39;</span><span class="p">,</span> <span class="s1">&#39;-bfs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000000</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--learning_starts&#39;</span><span class="p">,</span> <span class="s1">&#39;-ls&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tau&#39;</span><span class="p">,</span> <span class="s1">&#39;-tu&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.005</span><span class="p">)</span>
<span class="c1"># for DDPG noise only</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sigma&#39;</span><span class="p">,</span> <span class="s1">&#39;-sig&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="c1">#---------------------------------------------------------------------------------------------#</span>
<span class="c1"># register run name</span>
<span class="n">experiment_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">environment</span> <span class="o">+</span> \
    <span class="s1">&#39;-episodes_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">episodes</span><span class="p">)</span>
<span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39;-seed_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
<span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">experiment_date</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
<span class="c1"># Check if MLFLOW_TRACKING_URI is defined</span>
<span class="n">mlflow_tracking_uri</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MLFLOW_TRACKING_URI&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">mlflow_tracking_uri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Check ping to server</span>
    <span class="n">mlflow_ip</span> <span class="o">=</span> <span class="n">mlflow_tracking_uri</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># If server is not valid, setting default local path to mlflow</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;ping -c 1 &quot;</span> <span class="o">+</span> <span class="n">mlflow_ip</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="s1">&#39;file://&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/mlruns&#39;</span><span class="p">)</span>
<span class="c1"># MLflow track</span>
<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="n">name</span><span class="p">):</span>
    <span class="c1"># Log experiment params</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;sinergym-version&#39;</span><span class="p">,</span> <span class="n">sinergym</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>

    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;env&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">environment</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;episodes&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">episodes</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;algorithm&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">algorithm</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;reward&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">reward</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;normalization&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">normalization</span><span class="p">))</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;multi-observations&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">multiobs</span><span class="p">))</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;logger&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">logger</span><span class="p">))</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;tensorboard&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;evaluation&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">evaluation</span><span class="p">))</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;evaluation-frequency&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_freq</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;evaluation-length&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">eval_length</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;log-interval&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">log_interval</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;remote-store&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">remote_store</span><span class="p">))</span>

    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;learning_rate&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;n_steps&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">n_steps</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">gamma</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;gae_lambda&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">gae_lambda</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;ent_coef&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">ent_coef</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;buffer_size&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;vf_coef&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">vf_coef</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;max_grad_norm&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">max_grad_norm</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;rms_prop_eps&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">rms_prop_eps</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;learning_starts&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">learning_starts</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;tau&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">sigma</span><span class="p">)</span>

    <span class="c1"># Environment construction (with reward specified)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">reward</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="n">reward</span><span class="o">=</span><span class="n">LinearReward</span><span class="p">())</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">reward</span> <span class="o">==</span> <span class="s1">&#39;exponential&#39;</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">environment</span><span class="p">,</span> <span class="n">reward</span><span class="o">=</span><span class="n">ExpReward</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Reward function specified is not registered.&#39;</span><span class="p">)</span>

    <span class="c1"># env wrappers (optionals)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">normalization</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">NormalizeObservation</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">LoggerWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">multiobs</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">MultiObsWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>

    <span class="c1">######################## TRAINING ########################</span>

    <span class="c1"># env wrappers (optionals)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">normalization</span><span class="p">:</span>
        <span class="c1"># We have to know what dictionary ranges to use</span>
        <span class="n">norm_range</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">env_type</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">env_type</span> <span class="o">==</span> <span class="s1">&#39;datacenter&#39;</span><span class="p">:</span>
            <span class="n">norm_range</span> <span class="o">=</span> <span class="n">RANGES_DATACENTER</span>
        <span class="k">elif</span> <span class="n">env_type</span> <span class="o">==</span> <span class="s1">&#39;5Zone&#39;</span><span class="p">:</span>
            <span class="n">norm_range</span> <span class="o">=</span> <span class="n">RANGES_5ZONE</span>
        <span class="k">elif</span> <span class="n">env_type</span> <span class="o">==</span> <span class="s1">&#39;IWMullion&#39;</span><span class="p">:</span>
            <span class="n">norm_range</span> <span class="o">=</span> <span class="n">RANGES_IW</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;env_type is not valid, check environment name&#39;</span><span class="p">)</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">NormalizeObservation</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="n">norm_range</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">logger</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">LoggerWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">multiobs</span><span class="p">:</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">MultiObsWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="c1"># Defining model(algorithm)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1">#--------------------------DQN---------------------------#</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;DQN&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">DQN</span><span class="p">(</span><span class="s1">&#39;MlpPolicy&#39;</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">learning_rate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                    <span class="n">buffer_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">,</span>
                    <span class="n">learning_starts</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                    <span class="n">tau</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span>
                    <span class="n">gamma</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
                    <span class="n">train_freq</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                    <span class="n">gradient_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">target_update_interval</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                    <span class="n">exploration_fraction</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span>
                    <span class="n">exploration_initial_eps</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">exploration_final_eps</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span>
                    <span class="n">max_grad_norm</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_grad_norm</span><span class="p">,</span>
                    <span class="n">seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                    <span class="n">tensorboard_log</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">)</span>
    <span class="c1">#--------------------------------------------------------#</span>

    <span class="c1">#--------------------------DDPG--------------------------#</span>
    <span class="c1"># The noise objects for DDPG</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;DDPG&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">sigma</span><span class="p">:</span>
            <span class="n">n_actions</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">action_noise</span> <span class="o">=</span> <span class="n">NormalActionNoise</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                <span class="n">n_actions</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_actions</span><span class="p">))</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">DDPG</span><span class="p">(</span><span class="s2">&quot;MlpPolicy&quot;</span><span class="p">,</span>
                     <span class="n">env</span><span class="p">,</span>
                     <span class="n">action_noise</span><span class="o">=</span><span class="n">action_noise</span><span class="p">,</span>
                     <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                     <span class="n">tensorboard_log</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">)</span>
    <span class="c1">#--------------------------------------------------------#</span>

    <span class="c1">#--------------------------A2C---------------------------#</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;A2C&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">A2C</span><span class="p">(</span><span class="s1">&#39;MlpPolicy&#39;</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">learning_rate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                    <span class="n">n_steps</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">n_steps</span><span class="p">,</span>
                    <span class="n">gamma</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
                    <span class="n">gae_lambda</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">gae_lambda</span><span class="p">,</span>
                    <span class="n">ent_coef</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">ent_coef</span><span class="p">,</span>
                    <span class="n">vf_coef</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">vf_coef</span><span class="p">,</span>
                    <span class="n">max_grad_norm</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_grad_norm</span><span class="p">,</span>
                    <span class="n">rms_prop_eps</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">rms_prop_eps</span><span class="p">,</span>
                    <span class="n">seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                    <span class="n">tensorboard_log</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">)</span>
    <span class="c1">#--------------------------------------------------------#</span>

    <span class="c1">#--------------------------PPO---------------------------#</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;PPO&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">PPO</span><span class="p">(</span><span class="s1">&#39;MlpPolicy&#39;</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">learning_rate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                    <span class="n">n_steps</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">n_steps</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                    <span class="n">n_epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">gamma</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
                    <span class="n">gae_lambda</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">gae_lambda</span><span class="p">,</span>
                    <span class="n">clip_range</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span>
                    <span class="n">ent_coef</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">vf_coef</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span>
                    <span class="n">max_grad_norm</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_grad_norm</span><span class="p">,</span>
                    <span class="n">seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                    <span class="n">tensorboard_log</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">)</span>
    <span class="c1">#--------------------------------------------------------#</span>

    <span class="c1">#--------------------------SAC---------------------------#</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;SAC&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">SAC</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="s1">&#39;MlpPolicy&#39;</span><span class="p">,</span>
                    <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
                    <span class="n">seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                    <span class="n">tensorboard_log</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">)</span>
    <span class="c1">#--------------------------------------------------------#</span>

    <span class="c1">#--------------------------TD3---------------------------#</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">algorithm</span> <span class="o">==</span> <span class="s1">&#39;TD3&#39;</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">TD3</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="s1">&#39;MlpPolicy&#39;</span><span class="p">,</span>
                    <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                    <span class="n">tensorboard_log</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">,</span>
                    <span class="n">learning_rate</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_rate</span><span class="p">,</span>
                    <span class="n">buffer_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">buffer_size</span><span class="p">,</span>
                    <span class="n">learning_starts</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">learning_starts</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                    <span class="n">tau</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span>
                    <span class="n">gamma</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
                    <span class="n">train_freq</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;episode&#39;</span><span class="p">),</span>
                    <span class="n">gradient_steps</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">action_noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">replay_buffer_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">replay_buffer_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">optimize_memory_usage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">policy_delay</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">target_policy_noise</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                    <span class="n">target_noise_clip</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">create_eval_env</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">policy_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">device</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                    <span class="n">_init_setup_model</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#--------------------------------------------------------#</span>

    <span class="c1">#-------------------------ERROR?-------------------------#</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Algorithm specified is not registered.&#39;</span><span class="p">)</span>
    <span class="c1">#--------------------------------------------------------#</span>

    <span class="c1"># Calculating n_timesteps_episode for training</span>
    <span class="n">n_timesteps_episode</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">_eplus_one_epi_len</span> <span class="o">/</span> \
        <span class="n">env</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">_eplus_run_stepsize</span>
    <span class="n">timesteps</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">episodes</span> <span class="o">*</span> <span class="n">n_timesteps_episode</span>

    <span class="c1"># For callbacks processing</span>
    <span class="n">env_vec</span> <span class="o">=</span> <span class="n">DummyVecEnv</span><span class="p">([</span><span class="k">lambda</span><span class="p">:</span> <span class="n">env</span><span class="p">])</span>

    <span class="c1"># Using Callbacks for training</span>
    <span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Set up Evaluation and saving best model</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">evaluation</span><span class="p">:</span>
        <span class="n">eval_callback</span> <span class="o">=</span> <span class="n">LoggerEvalCallback</span><span class="p">(</span>
            <span class="n">env_vec</span><span class="p">,</span>
            <span class="n">best_model_save_path</span><span class="o">=</span><span class="s1">&#39;best_model/&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
            <span class="n">log_path</span><span class="o">=</span><span class="s1">&#39;best_model/&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
            <span class="n">eval_freq</span><span class="o">=</span><span class="n">n_timesteps_episode</span> <span class="o">*</span>
            <span class="n">args</span><span class="o">.</span><span class="n">eval_freq</span><span class="p">,</span>
            <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">render</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">n_eval_episodes</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">eval_length</span><span class="p">)</span>
        <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eval_callback</span><span class="p">)</span>

    <span class="c1"># Set up tensorboard logger</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">:</span>
        <span class="n">log_callback</span> <span class="o">=</span> <span class="n">LoggerCallback</span><span class="p">(</span><span class="n">sinergym_logger</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">logger</span><span class="p">))</span>
        <span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_callback</span><span class="p">)</span>
        <span class="c1"># lets change default dir for TensorboardFormatLogger only</span>
        <span class="n">tb_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span>
        <span class="n">new_logger</span> <span class="o">=</span> <span class="n">configure</span><span class="p">(</span><span class="n">tb_path</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;tensorboard&quot;</span><span class="p">])</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set_logger</span><span class="p">(</span><span class="n">new_logger</span><span class="p">)</span>

    <span class="n">callback</span> <span class="o">=</span> <span class="n">CallbackList</span><span class="p">(</span><span class="n">callbacks</span><span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="n">model</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span>
        <span class="n">total_timesteps</span><span class="o">=</span><span class="n">timesteps</span><span class="p">,</span>
        <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
        <span class="n">log_interval</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">log_interval</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">_env_working_dir_parent</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span><span class="p">)</span>

    <span class="c1"># If mlflow artifacts store is active</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mlflow_store</span><span class="p">:</span>
        <span class="c1"># Code for send output and tensorboard to mlflow artifacts.</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_artifacts</span><span class="p">(</span>
            <span class="n">local_dir</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">_env_working_dir_parent</span><span class="p">,</span>
            <span class="n">artifact_path</span><span class="o">=</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">evaluation</span><span class="p">:</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_artifacts</span><span class="p">(</span>
                <span class="n">local_dir</span><span class="o">=</span><span class="s1">&#39;best_model/&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
                <span class="n">artifact_path</span><span class="o">=</span><span class="s1">&#39;best_model/&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="c1"># If tensorboard is active (in local) we should send to mlflow</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span> <span class="ow">and</span> <span class="s1">&#39;gs://experiments-storage&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">:</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_artifacts</span><span class="p">(</span>
                <span class="n">local_dir</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
                <span class="n">artifact_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

    <span class="c1"># Store all results if remote_store flag is True (Google Cloud Bucket for</span>
    <span class="c1"># experiments)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">remote_store</span><span class="p">:</span>
        <span class="c1"># Initiate Google Cloud client</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">gcloud</span><span class="o">.</span><span class="n">init_storage_client</span><span class="p">()</span>
        <span class="c1"># Code for send output and tensorboard to common resource here.</span>
        <span class="n">gcloud</span><span class="o">.</span><span class="n">upload_to_bucket</span><span class="p">(</span>
            <span class="n">client</span><span class="p">,</span>
            <span class="n">src_path</span><span class="o">=</span><span class="n">env</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">_env_working_dir_parent</span><span class="p">,</span>
            <span class="n">dest_bucket_name</span><span class="o">=</span><span class="s1">&#39;experiments-storage&#39;</span><span class="p">,</span>
            <span class="n">dest_path</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">evaluation</span><span class="p">:</span>
            <span class="n">gcloud</span><span class="o">.</span><span class="n">upload_to_bucket</span><span class="p">(</span>
                <span class="n">client</span><span class="p">,</span>
                <span class="n">src_path</span><span class="o">=</span><span class="s1">&#39;best_model/&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
                <span class="n">dest_bucket_name</span><span class="o">=</span><span class="s1">&#39;experiments-storage&#39;</span><span class="p">,</span>
                <span class="n">dest_path</span><span class="o">=</span><span class="s1">&#39;best_model/&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="c1"># If tensorboard is active (in local) we should send to bucket</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span> <span class="ow">and</span> <span class="s1">&#39;gs://experiments-storage&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">:</span>
            <span class="n">gcloud</span><span class="o">.</span><span class="n">upload_to_bucket</span><span class="p">(</span>
                <span class="n">client</span><span class="p">,</span>
                <span class="n">src_path</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
                <span class="n">dest_bucket_name</span><span class="o">=</span><span class="s1">&#39;experiments-storage&#39;</span><span class="p">,</span>
                <span class="n">dest_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tensorboard</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="c1"># gcloud.upload_to_bucket(</span>
        <span class="c1">#     client,</span>
        <span class="c1">#     src_path=&#39;mlruns/&#39;,</span>
        <span class="c1">#     dest_bucket_name=&#39;experiments-storage&#39;,</span>
        <span class="c1">#     dest_path=&#39;mlruns/&#39;)</span>

    <span class="c1"># End mlflow run</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">end_run</span><span class="p">()</span>

    <span class="c1"># If it is a Google Cloud VM and experiment flag auto_delete has been</span>
    <span class="c1"># activated, shutdown remote machine when ends</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">group_name</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">auto_delete</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">gcloud</span><span class="o">.</span><span class="n">get_service_account_token</span><span class="p">()</span>
        <span class="n">gcloud</span><span class="o">.</span><span class="n">delete_instance_MIG_from_container</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">group_name</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>DRL_battery.py</strong> is able to be used to local experiments into client computer. For example, <code class="docutils literal notranslate"><span class="pre">--auto_delete</span></code> parameter will have no effect in experiment. This experiments results could be sent to bucket and mlflow artifacts if it is specified. We will see it.</p>
</div>
<p>The list of parameter is pretty large. Let's see it:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--environment</span></code> or <code class="docutils literal notranslate"><span class="pre">-env</span></code>: Environment name you want to use (see <a class="reference internal" href="environments.html#environments"><span class="std std-ref">Environments</span></a>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--episodes</span></code> or <code class="docutils literal notranslate"><span class="pre">-ep</span></code>: Number of episodes you want to train agent in simulation (Depending on environment episode length can be different)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--algorithm</span></code> or <code class="docutils literal notranslate"><span class="pre">-alg</span></code>: Algorithm you want to use to train (Currently, it is available <em>PPO</em>, <em>A2C</em>, <em>DQN</em>, <em>DDPG</em> and <em>SAC</em>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--reward</span></code> or <code class="docutils literal notranslate"><span class="pre">-rw</span></code>: Reward class you want to use for reward function. Currently, possible values are &quot;linear&quot; and &quot;exponential&quot;(see <a class="reference internal" href="rewards.html#rewards"><span class="std std-ref">Rewards</span></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--normalization</span></code> or <code class="docutils literal notranslate"><span class="pre">-norm</span></code>: Apply normalization wrapper to observations during training. If it isn't specified wrapper will not be applied (see <a class="reference internal" href="wrappers.html#wrappers"><span class="std std-ref">Wrappers</span></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--multiobs</span></code> or <code class="docutils literal notranslate"><span class="pre">-mobs</span></code>: Apply Multi-Observation wrapper to observations during training. If it isn't specified wrapper will not be applied (see <a class="reference internal" href="wrappers.html#wrappers"><span class="std std-ref">Wrappers</span></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--logger</span></code> or <code class="docutils literal notranslate"><span class="pre">-log</span></code>: Apply Sinergym logger wrapper during training. If it isn't specified wrapper will not be applied (see <a class="reference internal" href="wrappers.html#wrappers"><span class="std std-ref">Wrappers</span></a> and <a class="reference internal" href="output.html#logger"><span class="std std-ref">Logger</span></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--tensorboard</span></code> or <code class="docutils literal notranslate"><span class="pre">-tens</span></code>: This parameter will contain a <strong>path-file</strong> or <strong>path-remote-bucket</strong> to allocate tensorboard training logs. If it isn't specified this log will be deactivate (see <a class="reference internal" href="deep-reinforcement-learning.html#drl-logger"><span class="std std-ref">DRL Logger</span></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--evaluation</span></code> or <code class="docutils literal notranslate"><span class="pre">-eval</span></code>: If it is specified, evaluation callback will be activate, else model evaluation will be deactivate during training (see <a class="reference internal" href="deep-reinforcement-learning.html#deep-reinforcement-learning-integration"><span class="std std-ref">Deep Reinforcement Learning Integration</span></a>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--eval_freq</span></code> or <code class="docutils literal notranslate"><span class="pre">-evalf</span></code>: Only if <code class="docutils literal notranslate"><span class="pre">--evaluation</span></code> flag has been written. Episode frequency for evaluation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--eval_length</span></code> or <code class="docutils literal notranslate"><span class="pre">-evall</span></code>: Only if <code class="docutils literal notranslate"><span class="pre">--evaluation</span></code> flag has been written. Number of episodes for each evaluation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--log_interval</span></code> or <code class="docutils literal notranslate"><span class="pre">-inter</span></code>: This parameter is used for <code class="docutils literal notranslate"><span class="pre">learn()</span></code> method in each algorithm. It is important specify a correct value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--seed</span></code> or <code class="docutils literal notranslate"><span class="pre">-sd</span></code>: Seed for training, random components in process will be able to be recreated.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--remote_store</span></code> or <code class="docutils literal notranslate"><span class="pre">-sto</span></code>: Determine if sinergym output and tensorboard log (when a local path is specified and not a remote bucket path) will be sent to a common resource (Bucket), else will be allocate in remote container memory only.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--mlflow_store</span></code> or <code class="docutils literal notranslate"><span class="pre">-mlflow</span></code>: Determine if sinergym output and tensorboard log (when a local path is specified and not a remote bucket path) will be sent to a Mlflow Artifact, else will be allocate in remote container memory only.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--group_name</span></code> or <code class="docutils literal notranslate"><span class="pre">-group</span></code>: It specify to which MIG the host instance belongs, it is important if --auto-delete is activated.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--auto_delete</span></code> or <code class="docutils literal notranslate"><span class="pre">-del</span></code>: Whether this parameter is specified, remote instance will be auto removed when its job has finished.</p></li>
<li><p><strong>algorithm hyperparameters</strong>: Execute <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">DRL_battery</span> <span class="pre">--help</span></code> for more information.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>For a correct auto_delete functionality, please, use MIG's instead of individual instances.</p>
</div>
<p>This script do the next:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Setting an appropriate name for the experiment. Following the next format: <code class="docutils literal notranslate"><span class="pre">&lt;algorithm&gt;-&lt;environment_name&gt;-episodes&lt;episodes_int&gt;-seed&lt;seed_value&gt;(&lt;experiment_date&gt;)</span></code></p></li>
<li><p>Starting Mlflow track experiment with that name, if mlflow server is not available, it will be used an local path (<em>./mlruns</em>) in remote container.</p></li>
<li><p>Log all MlFlow parameters (including <em>sinergym.__version__</em>).</p></li>
<li><p>Setting reward function specified in <code class="docutils literal notranslate"><span class="pre">--reward</span></code> parameter.</p></li>
<li><p>Setting wrappers specified in environment.</p></li>
<li><p>Defining model algorithm using hyperparameters.</p></li>
<li><p>Calculate training timesteps using number of episodes.</p></li>
<li><p>Setting up evaluation callback if it has been specified.</p></li>
<li><p>Setting up Tensorboard logger callback if it has been specified.</p></li>
<li><p>Training with environment.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">--remote_store</span></code> has been specified, saving all outputs in Google Cloud Bucket. If <code class="docutils literal notranslate"><span class="pre">--mlflow_store</span></code> has been specified, saving all outputs in Mlflow run artifact.</p></li>
<li><p>Auto-delete remote container in Google Cloud Platform when parameter <code class="docutils literal notranslate"><span class="pre">--auto_delete</span></code> has been specified.</p></li>
</ol>
</div></blockquote>
<section id="containers-permission-to-bucket-storage-output">
<h3>Containers permission to bucket storage output<a class="headerlink" href="#containers-permission-to-bucket-storage-output" title="Permalink to this headline"></a></h3>
<p>As you see in sinergym template explained in <a class="reference internal" href="#create-your-vm-or-mig"><span class="std std-ref">4. Create your VM or MIG</span></a>, it is specified <code class="docutils literal notranslate"><span class="pre">--scope</span></code>, <code class="docutils literal notranslate"><span class="pre">--service-account</span></code> and <code class="docutils literal notranslate"><span class="pre">--container-env</span></code>. This aim to <em>remote_store</em> option in <em>DRL_battery.py</em> works correctly.
Those parameters provide each container with permissions to write in the bucket and manage Google Cloud Platform (auto instance remove function).
Container environment variables indicate zone, project_id and mlflow tracking server uri need it in <a class="reference internal" href="#mlflow-tracking-server-set-up"><span class="std std-ref">Mlflow tracking server set up</span></a>.</p>
<p>Hence, it is <strong>necessary</strong> to <strong>set up this service account</strong> and give privileges in order to that objective. Then, following <a class="reference external" href="https://cloud.google.com/docs/authentication/getting-started">Google authentication documentation</a> we will do the next:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ gcloud iam service-accounts create storage-account
$ gcloud projects add-iam-policy-binding PROJECT_ID --member<span class="o">=</span><span class="s2">&quot;serviceAccount:storage-account@PROJECT_ID.iam.gserviceaccount.com&quot;</span> --role<span class="o">=</span><span class="s2">&quot;roles/owner&quot;</span>
$ gcloud iam service-accounts keys create PROJECT_PATH/google-storage.json --iam-account<span class="o">=</span>storage-account@PROJECT_ID.iam.gserviceaccount.com
$ <span class="nb">export</span> <span class="nv">GOOGLE_CLOUD_CREDENTIALS</span><span class="o">=</span> PROJECT_PATH/google-storage.json
</pre></div>
</div>
<p>In short, we create a new service account called <strong>storage-account</strong>. Then, we dote this account with <em>roles/owner</em> permission. The next step is create a file key (json) called <strong>google-storage.json</strong> in our project root (gitignore will ignore this file in remote).
Finally, we export this file in <strong>GOOGLE_CLOUD_CREDENTIALS</strong> in our local computer in order to gcloud SDK knows that it has to use that token to authenticate.</p>
</section>
</section>
<section id="remote-tensorboard-log">
<h2>Remote Tensorboard log<a class="headerlink" href="#remote-tensorboard-log" title="Permalink to this headline"></a></h2>
<p>In <code class="docutils literal notranslate"><span class="pre">--tensorboard</span></code> parameter we have to specify a <strong>local path</strong> or a <strong>Bucket path</strong>.</p>
<p>If we specify a <strong>local path</strong>, tensorboard logs will be stored in remote containers memory. If you have specified <code class="docutils literal notranslate"><span class="pre">--remote_store</span></code> or <code class="docutils literal notranslate"><span class="pre">--mlflow_store</span></code>, this logs will be sent to those remote storage when experiment finishes.
One of the strengths of Tensorboard is the ability to see the data in real time as the training is running. Thus, it is recommended to define in <code class="docutils literal notranslate"><span class="pre">--tensorboard</span></code> the <strong>bucket path</strong> directly in order to send that information
as the training is generating it (see <a class="reference external" href="https://github.com/ContinualAI/avalanche/pull/628">this issue</a> for more information). In our project we have <em>gs://experiments-storage/tensorboard_log</em> but you can have whatever you want.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If in <code class="docutils literal notranslate"><span class="pre">--tensorboard</span></code> you have specified a gs path, <code class="docutils literal notranslate"><span class="pre">--remote_store</span></code> or <code class="docutils literal notranslate"><span class="pre">--mlflow_store</span></code> parameters don't store tensorboard logs.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Whether you have written a bucket path, don't write <code class="docutils literal notranslate"><span class="pre">/</span></code> at the end (<em>gs://experiments-storage/tensorboard_log/</em>), this causes that real-time remote storage doesn't work correctly.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>In the case that gs URI isn't recognized. Maybe is due to your tensorboard installation hasn't got access your google account. Try <a class="reference external" href="https://cloud.google.com/sdk/gcloud/reference/auth/application-default/login">gcloud auth application-default login</a> command.</p>
</div>
<section id="visualize-remote-tensorboard-log-in-real-time">
<h3>Visualize remote Tensorboard log in real-time<a class="headerlink" href="#visualize-remote-tensorboard-log-in-real-time" title="Permalink to this headline"></a></h3>
<dl class="simple">
<dt>You have two options:</dt><dd><ol class="arabic simple">
<li><p>Create a remote server with tensorboard service deployed.</p></li>
<li><p>Initiate that service in your local computer, reading from the bucket log, and access to the visualization in <em>http://localhost:6006</em></p></li>
</ol>
</dd>
</dl>
<p>The second options is enough since we can read from bucket when we need directly and shut down local service when we finish.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>$ tensorboard --logdir gs://experiments-storage/tensorboard_log/
</pre></div>
</div>
</section>
</section>
<section id="mlflow-tracking-server-set-up">
<h2>Mlflow tracking server set up<a class="headerlink" href="#mlflow-tracking-server-set-up" title="Permalink to this headline"></a></h2>
<p>Mlflow tracking server can be set up into your google account in order to organize your own experiments (<a class="reference internal" href="deep-reinforcement-learning.html#mlflow"><span class="std std-ref">Mlflow</span></a>). You can separate <strong>back-end</strong> (SQL database) from tracking server.
In this way, you can shut down or delete server instance without loose your experiments run data, since SQL is always up. Let's see how:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1"># This scrip is used to build a mlflow server in Google Cloud, it is important</span>
<span class="c1"># to set up account previously.</span>

<span class="c1"># Please, visit our documentation here --&gt; https://jajimer.github.io/sinergym/build/html/index.html</span>

<span class="c1"># Step 0 - Store all parameters</span>

<span class="nv">PROJECT_ID</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">BUCKET_NAME</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">ZONE</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">REGION</span><span class="o">=</span><span class="si">${</span><span class="nv">ZONE</span><span class="p">:</span><span class="k">:-</span><span class="nv">2</span><span class="si">}</span>
<span class="nv">DB_ROOT_PASSWORD</span><span class="o">=</span><span class="nv">$4</span>
<span class="nv">MACHINE_TYPE</span><span class="o">=</span>e2-medium
<span class="nv">MLFLOW_IMAGE</span><span class="o">=</span>kaysush/mlflow:1.14.1
<span class="nv">CLOUD_SQL_PROXY_IMAGE</span><span class="o">=</span>gcr.io/cloudsql-docker/gce-proxy:1.19.1
<span class="nv">MYSQL_INSTANCE</span><span class="o">=</span><span class="si">${</span><span class="nv">PROJECT_ID</span><span class="si">}</span>:<span class="si">${</span><span class="nv">REGION</span><span class="si">}</span>:mlflow-backend

<span class="c1"># Step 1 - Service account for mlflow service</span>
<span class="nb">echo</span> <span class="s2">&quot;Creating Service account for mlflow service [mlflow-tracking-sa]...&quot;</span>
gcloud iam service-accounts create mlflow-tracking-sa --description<span class="o">=</span><span class="s2">&quot;Service Account to run the MLFLow tracking server&quot;</span> --display-name<span class="o">=</span><span class="s2">&quot;MLFlow tracking SA&quot;</span>

<span class="c1"># Step 2 - Artifact used by mlflow to store all runs information</span>
<span class="nb">echo</span> <span class="s2">&quot;Creating Back-end artifact bucket [</span><span class="nv">$BUCKET_NAME</span><span class="s2">]...&quot;</span>
gsutil mb gs://<span class="nv">$BUCKET_NAME</span>

<span class="c1"># Step 3 - CLoud SQL, instance with SQL and &quot;mlflow&quot; database inner</span>
<span class="nb">echo</span> <span class="s2">&quot;Creating sql instance with mlflow database [mlflow-backend]...&quot;</span>
gcloud sql instances create mlflow-backend --tier<span class="o">=</span>db-f1-micro --region<span class="o">=</span><span class="si">${</span><span class="nv">REGION</span><span class="si">}</span> --root-password<span class="o">=</span><span class="si">${</span><span class="nv">DB_ROOT_PASSWORD</span><span class="si">}</span> --storage-type<span class="o">=</span>SSD
gcloud sql databases create mlflow --instance<span class="o">=</span>mlflow-backend

<span class="c1"># Step 4 - IAM: Provisioning service account privileges in order to manipulate bucket and back-end</span>
<span class="nb">echo</span> <span class="s2">&quot;Creating service account privileges to use Back-end [roles/cloudsql.editor]...&quot;</span>
gsutil iam ch <span class="s2">&quot;serviceAccount:mlflow-tracking-sa@</span><span class="si">${</span><span class="nv">PROJECT_ID</span><span class="si">}</span><span class="s2">.iam.gserviceaccount.com:roles/storage.admin&quot;</span> gs://<span class="si">${</span><span class="nv">BUCKET_NAME</span><span class="si">}</span>
gcloud projects add-iam-policy-binding <span class="si">${</span><span class="nv">PROJECT_ID</span><span class="si">}</span> --member<span class="o">=</span><span class="s2">&quot;serviceAccount:mlflow-tracking-sa@</span><span class="si">${</span><span class="nv">PROJECT_ID</span><span class="si">}</span><span class="s2">.iam.gserviceaccount.com&quot;</span> --role<span class="o">=</span>roles/cloudsql.editor

<span class="c1"># Step 5 - Creating start_mlflow_tracking.sh to initialize instance</span>
<span class="nb">echo</span> <span class="s2">&quot;Creating start_mlflow_tracking.sh to initialize instance...&quot;</span>
cat <span class="s">&lt;&lt;EOF &gt;./start_mlflow_tracking.sh</span>
<span class="s">echo &quot;Starting Cloud SQL Proxy&#39;&quot;</span>
<span class="s">docker run -d --name mysql  --net host -p 3306:3306 $CLOUD_SQL_PROXY_IMAGE /cloud_sql_proxy -instances $MYSQL_INSTANCE=tcp:0.0.0.0:3306</span>

<span class="s">echo &quot;Starting mlflow-tracking server&quot;</span>
<span class="s">docker run -d --name mlflow-tracking --net host -p 5000:5000 $MLFLOW_IMAGE mlflow server --backend-store-uri mysql+pymysql://root:${DB_ROOT_PASSWORD}@localhost/mlflow --default-artifact-root gs://${BUCKET_NAME}/mlflow_artifacts/ --host 0.0.0.0</span>

<span class="s">echo &quot;Altering IPTables&quot;</span>
<span class="s">iptables -A INPUT -p tcp --dport 5000 -j ACCEPT</span>
<span class="s">EOF</span>

<span class="c1"># Step 6 - Uploading start script and deleting from local</span>
<span class="nb">echo</span> <span class="s2">&quot;Uploading start_mlflow_tracking.sh at gs://</span><span class="si">${</span><span class="nv">BUCKET_NAME</span><span class="si">}</span><span class="s2">/scripts/start_mlflow_tracking.sh...&quot;</span>
gsutil cp ./start_mlflow_tracking.sh gs://<span class="si">${</span><span class="nv">BUCKET_NAME</span><span class="si">}</span>/scripts/start_mlflow_tracking.sh
<span class="nb">echo</span> <span class="s2">&quot;Deleting temporal local script [start_mlflow_tracking.sh]&quot;</span>
rm ./start_mlflow_tracking.sh

<span class="c1">#Step 7 - creating static external ip for mlflow server</span>
<span class="nb">echo</span> <span class="s2">&quot;Creating static external ip for mlflow-tracking-server [mlflow-ip]&quot;</span>
gcloud compute addresses create mlflow-ip <span class="se">\</span>
    --region europe-west1

<span class="c1"># Step 8 - Compute Instance</span>
<span class="nb">echo</span> <span class="s2">&quot;Deploying remote server [mlflow-tracking-server]...&quot;</span>
gcloud compute --project<span class="o">=</span><span class="nv">$PROJECT_ID</span> instances create mlflow-tracking-server <span class="se">\</span>
    --zone<span class="o">=</span><span class="nv">$ZONE</span> <span class="se">\</span>
    --machine-type<span class="o">=</span><span class="nv">$MACHINE_TYPE</span> <span class="se">\</span>
    --subnet<span class="o">=</span>default <span class="se">\</span>
    --network-tier<span class="o">=</span>PREMIUM <span class="se">\</span>
    --metadata<span class="o">=</span>startup-script-url<span class="o">=</span>gs://<span class="si">${</span><span class="nv">BUCKET_NAME</span><span class="si">}</span>/scripts/start_mlflow_tracking.sh <span class="se">\</span>
    --maintenance-policy<span class="o">=</span>MIGRATE <span class="se">\</span>
    --service-account<span class="o">=</span>mlflow-tracking-sa@<span class="si">${</span><span class="nv">PROJECT_ID</span><span class="si">}</span>.iam.gserviceaccount.com <span class="se">\</span>
    --scopes<span class="o">=</span>https://www.googleapis.com/auth/cloud-platform <span class="se">\</span>
    --tags<span class="o">=</span>mlflow-tracking-server <span class="se">\</span>
    --image<span class="o">=</span>cos-77-12371-1109-0 <span class="se">\</span>
    --image-project<span class="o">=</span>cos-cloud <span class="se">\</span>
    --boot-disk-size<span class="o">=</span>10GB <span class="se">\</span>
    --boot-disk-type<span class="o">=</span>pd-balanced <span class="se">\</span>
    --boot-disk-device-name<span class="o">=</span>mlflow-tracking-server <span class="se">\</span>
    --no-shielded-secure-boot <span class="se">\</span>
    --shielded-vtpm <span class="se">\</span>
    --shielded-integrity-monitoring <span class="se">\</span>
    --reservation-affinity<span class="o">=</span>any <span class="se">\</span>
    --address <span class="k">$(</span>gcloud compute addresses describe mlflow-ip --format<span class="o">=</span><span class="s1">&#39;get(address)&#39;</span><span class="k">)</span>

<span class="c1"># Step 8 - Firewall</span>
<span class="nb">echo</span> <span class="s2">&quot;Creating firewall rules [allow-mlflow-tracking]...&quot;</span>
gcloud compute firewall-rules create allow-mlflow-tracking --network default --priority <span class="m">1000</span> --direction ingress --action allow --target-tags mlflow-tracking-server --source-ranges <span class="m">0</span>.0.0.0/0 --rules tcp:5000 --enable-logging
</pre></div>
</div>
<p>This bash script defines all the process to configure this functionality automatically. (Once you execute it you don't have to use this script anymore). The arguments it needs are:
<em>PROJECT_ID</em>, <em>BUCKET_NAME</em>, <em>ZONE</em> and <em>DB_ROOT_PASSWORD</em>.</p>
<p>This script do the next for you:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Creating Service account for mlflow service <cite>[mlflow-tracking-sa]</cite>.</p></li>
<li><p>Creating Back-end artifact bucket.</p></li>
<li><p>Creating SQL instance with root password specified in argument 4.</p></li>
<li><p>Creating mlflow database inner SQL instance.</p></li>
<li><p>Creating service account privileges to use Back-end <cite>[roles/cloudsql.editor]</cite></p></li>
<li><p>Generating an automatic script called <strong>start_mlflow_tracking.sh</strong> and sending to <code class="docutils literal notranslate"><span class="pre">gs://&lt;BUCKET_NAME&gt;/scripts/</span></code></p></li>
<li><p>Deleting local <strong>start_mlflow_tracking.sh</strong> file.</p></li>
<li><p>Creating static external IP for <cite>mlflow-tracking-server</cite></p></li>
<li><p>Deploying remote server <cite>[mlflow-tracking-server]</cite></p></li>
</ol>
</div></blockquote>
<p>Step 8 is very important, this allows you to delete server instance and create again when you need it without redefining server IP in sinergym-template for remote container experiments.
Notice that server instance creation use service account for mlflow, with this configuration mlflow can read from SQL server. In <a class="reference internal" href="#create-your-vm-or-mig"><span class="std std-ref">4. Create your VM or MIG</span></a> it is specified MLFLOW_TRACKING_URI container environment variable using that external static IP.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is important execute this script before create sinergym-template instances in order to annotate <cite>mlflow-server-ip</cite>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you want to change any backend configuration, you can change any parameter of the script bellow.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Whether you have written <code class="docutils literal notranslate"><span class="pre">--mlflow_store</span></code>, Sinergym outputs will be sent to mlflow server as artifacts. These artifacts will be stored in the same bucket where is allocated <code class="docutils literal notranslate"><span class="pre">gs://&lt;BUCKET_NAME&gt;</span></code></p>
</div>
</section>
<section id="google-cloud-alerts">
<h2>Google Cloud Alerts<a class="headerlink" href="#google-cloud-alerts" title="Permalink to this headline"></a></h2>
<p><strong>Google Cloud Platform</strong> include functionality in order to trigger some events and generate alerts in consequence.
Then, a trigger has been created in our gcloud project which aim to advertise when an experiment has finished.
This alert can be captured in several ways (Slack, SMS, Email, etc).
If you want to do the same, please, check Google Cloud Alerts documentation <a class="reference external" href="https://cloud.google.com/monitoring/alerts">here</a>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="deep-reinforcement-learning.html" class="btn btn-neutral float-left" title="Deep Reinforcement Learning Integration" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="API-reference.html" class="btn btn-neutral float-right" title="API reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, J. Jiménez, J. Gómez, M. Molina, A. Manjavacas, A. Campoy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>