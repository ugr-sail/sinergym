<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>21. DRL usage example &mdash; Sinergym  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
      <link rel="stylesheet" type="text/css" href="../../_static/doc_theme.css?v=642ef2a8" />

  
    <link rel="shortcut icon" href="../../_static/logo-sidebar.png"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="API reference" href="../API-reference.html" />
    <link rel="prev" title="20. Rule Controller example" href="rule_controller_example.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #a5beba" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Sinergym
              <img src="../../_static/logo-sidebar.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Start Here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">1. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usage-example.html">2. Usage example</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">sinergym</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../buildings.html">3. Buildings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../weathers.html">4. Weathers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../environments.html">5. Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rewards.html">6. Rewards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../controllers.html">7. Controllers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../wrappers.html">8. Wrappers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extra-configuration.html">9. Extra Configuration in Sinergym simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../output.html">10. Output format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deep-reinforcement-learning.html">11. Deep Reinforcement Learning Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gcloudAPI.html">12. Sinergym with Google Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="../github-actions.html">13. Github Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tests.html">14. Tests</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basic_example.html">15. Basic example</a></li>
<li class="toctree-l1"><a class="reference internal" href="change_environment.html">16. Changing an environment registered in Sinergym</a></li>
<li class="toctree-l1"><a class="reference internal" href="default_building_control.html">17. Default building control setting up an empty action interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="wrappers_examples.html">18. Wrappers example</a></li>
<li class="toctree-l1"><a class="reference internal" href="personalize_loggerwrapper.html">19. Logger Wrapper personalization/configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="rule_controller_example.html">20. Rule Controller example</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">21. DRL usage example</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Training-a-model">21.1. Training a model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Loading-a-model">21.2. Loading a model</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../API-reference.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #a5beba" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Sinergym</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">21. </span>DRL usage example</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/pages/notebooks/drl.nblink.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="DRL-usage-example">
<h1><span class="section-number">21. </span>DRL usage example<a class="headerlink" href="#DRL-usage-example" title="Link to this heading"></a></h1>
<p>In this notebook example, Stable Baselines 3 has been used to train and to load an agent. However, Sinergym is completely agnostic to any DRL algorithm (although there are custom callbacks for SB3 specifically) and can be used with any DRL library that works with gymnasium environments.</p>
<section id="Training-a-model">
<h2><span class="section-number">21.1. </span>Training a model<a class="headerlink" href="#Training-a-model" title="Link to this heading"></a></h2>
<p>We are going to rely on the script available in the repository root called <code class="docutils literal notranslate"><span class="pre">DRL_battery.py</span></code>. This script applies all the possibilities that Sinergym has to work with deep reinforcement learning algorithms and set parameters to everything so that we can define the training options from the execution of the script easily by a JSON file.</p>
<p>For more information about how run <code class="docutils literal notranslate"><span class="pre">DRL_battery.py</span></code>, please, see <a class="reference external" href="https://ugr-sail.github.io/sinergym/compilation/main/pages/deep-reinforcement-learning.html#train-a-model">Train a model</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">gymnasium</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gym</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">wandb</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">stable_baselines3</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">stable_baselines3.common.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">CallbackList</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">stable_baselines3.common.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">HumanOutputFormat</span><span class="p">,</span> <span class="n">Logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">stable_baselines3.common.monitor</span><span class="w"> </span><span class="kn">import</span> <span class="n">Monitor</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sinergym</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sinergym.utils.gcloud</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gcloud</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sinergym.utils.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sinergym.utils.constants</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sinergym.utils.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">CSVLogger</span><span class="p">,</span> <span class="n">WandBOutputFormat</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sinergym.utils.rewards</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sinergym.utils.wrappers</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
</div>
<p>First let’s define some variables for the execution.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Environment ID</span>
<span class="n">environment</span> <span class="o">=</span> <span class="s2">&quot;Eplus-demo-v1&quot;</span>
<span class="c1"># Training episodes</span>
<span class="n">episodes</span> <span class="o">=</span> <span class="mi">4</span>
<span class="c1">#Name of the experiment</span>
<span class="n">experiment_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H:%M&#39;</span><span class="p">)</span>
<span class="n">experiment_name</span> <span class="o">=</span> <span class="s1">&#39;SB3_DQN-&#39;</span> <span class="o">+</span> <span class="n">environment</span> <span class="o">+</span> \
    <span class="s1">&#39;-episodes-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">episodes</span><span class="p">)</span>
<span class="n">experiment_name</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">experiment_date</span>
</pre></div>
</div>
</div>
<p>We can combine this experiment executions with <a class="reference external" href="https://ugr-sail.github.io/sinergym/compilation/main/pages/deep-reinforcement-learning.html#weights-and-biases-structure">Weights&amp;Biases</a> in order to host all information extracted. With <em>wandb</em>, it’s possible to track and visualize all DRL training process in real time, register hyperparameters and details of each experiment, save artifacts such as models and <em>sinergym</em> output, and compare between different executions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create wandb.config object in order to log all experiment params</span>
<span class="n">experiment_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;sinergym-version&#39;</span><span class="p">:</span> <span class="n">sinergym</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
    <span class="s1">&#39;python-version&#39;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span>
<span class="p">}</span>
<span class="n">experiment_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;environment&#39;</span><span class="p">:</span><span class="n">environment</span><span class="p">,</span>
                          <span class="s1">&#39;episodes&#39;</span><span class="p">:</span><span class="n">episodes</span><span class="p">,</span>
                          <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span><span class="s1">&#39;SB3_DQN&#39;</span><span class="p">})</span>

<span class="c1"># Get wandb init params (you have to specify your own project and entity)</span>
<span class="n">wandb_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="s1">&#39;sinergym&#39;</span><span class="p">,</span>
                <span class="s2">&quot;entity&quot;</span><span class="p">:</span> <span class="s1">&#39;alex_ugr&#39;</span><span class="p">}</span>
<span class="c1"># Init wandb entry</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="n">experiment_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">wandb</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">generate_id</span><span class="p">(),</span>
    <span class="n">config</span><span class="o">=</span><span class="n">experiment_params</span><span class="p">,</span>
    <span class="o">**</span> <span class="n">wandb_params</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Failed to detect the name of this notebook, you can set it manually with the WANDB_NOTEBOOK_NAME environment variable to enable code saving.
<span class="ansi-blue-intense-fg ansi-bold">wandb</span>: Currently logged in as: <span class="ansi-yellow-fg">alex_ugr</span>. Use <span class="ansi-bold">`wandb login --relogin`</span> to force relogin
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
Tracking run with wandb version 0.14.0</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
Run data is saved locally in <code>/workspaces/sinergym/examples/wandb/run-20230405_145126-gxs4rau3</code></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
Syncing run <strong><a href='https://wandb.ai/alex_ugr/sinergym/runs/gxs4rau3' target="_blank">SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_nt18lsm5</a></strong> to <a href='https://wandb.ai/alex_ugr/sinergym' target="_blank">Weights & Biases</a> (<a href='https://wandb.me/run' target="_blank">docs</a>)<br/></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
View project at <a href='https://wandb.ai/alex_ugr/sinergym' target="_blank">https://wandb.ai/alex_ugr/sinergym</a></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
View run at <a href='https://wandb.ai/alex_ugr/sinergym/runs/gxs4rau3' target="_blank">https://wandb.ai/alex_ugr/sinergym/runs/gxs4rau3</a></div>
</div>
<p>Now we are ready to create the Gymnasium Environment. Here we use the environment name defined, remember that you can <a class="reference external" href="https://ugr-sail.github.io/sinergym/compilation/main/pages/notebooks/change_environment.html#Changing-an-environment-registered-in-Sinergym">change default environment configuration</a>. We will create a eval_env too in order to interact in the evaluation episodes. We can overwrite the env name with experiment name if we want.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">env_name</span><span class="o">=</span><span class="n">experiment_name</span><span class="p">)</span>
<span class="n">eval_env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">env_name</span><span class="o">=</span><span class="n">experiment_name</span><span class="o">+</span><span class="s1">&#39;_EVALUATION&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[2023-04-05 14:51:32,107] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:Updating idf ExternalInterface object if it is not present...
[2023-04-05 14:51:32,109] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:Updating idf Site:Location and SizingPeriod:DesignDay(s) to weather and ddy file...
[2023-04-05 14:51:32,112] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:Updating idf OutPut:Variable and variables XML tree model for BVCTB connection.
[2023-04-05 14:51:32,114] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:Setting up extra configuration in building model if exists...
[2023-04-05 14:51:32,116] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:Setting up action definition in building model if exists...
[2023-04-05 14:51:33,584] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:Updating idf ExternalInterface object if it is not present...
[2023-04-05 14:51:33,586] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:Updating idf Site:Location and SizingPeriod:DesignDay(s) to weather and ddy file...
[2023-04-05 14:51:33,590] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:Updating idf OutPut:Variable and variables XML tree model for BVCTB connection.
[2023-04-05 14:51:33,592] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:Setting up extra configuration in building model if exists...
[2023-04-05 14:51:33,593] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:Setting up action definition in building model if exists...
</pre></div></div>
</div>
<p>We can also add a Wrapper to the environment, we are going to use a Logger (extension of <code class="docutils literal notranslate"><span class="pre">gym.Wrapper</span></code>) this is used to monitor and log the interactions with the environment and save the data into a CSV. Files generated will be stored as artifact in <em>wandb</em> too.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="o">=</span> <span class="n">LoggerWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>At this point, we have the environment set up and ready to be used. We are going to create our learning model (Stable Baselines 3 DQN), but we can use any other algorithm.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">DQN</span><span class="p">(</span><span class="s1">&#39;MlpPolicy&#39;</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Using cpu device
Wrapping the env with a `Monitor` wrapper
Wrapping the env in a DummyVecEnv.
</pre></div></div>
</div>
<p>Now we need to calculate the number of timesteps of each episode for the evaluation. Evaluation will execute the current model during a number of episodes determined to decide if it is the best current version of the model at that point of the training. Output generated will be stored in <em>wandb</em> server too.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_timesteps_episode</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">_eplus_one_epi_len</span> <span class="o">/</span> \
                      <span class="n">env</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">_eplus_run_stepsize</span>
<br/></pre></div>
</div>
</div>
<p>We are going to use the LoggerEval callback to print and save the best model evaluated during training.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Set up Evaluation and saving best model</span>
<span class="n">eval_callback</span> <span class="o">=</span> <span class="n">LoggerEvalCallback</span><span class="p">(</span>
    <span class="n">eval_env</span><span class="p">,</span>
    <span class="n">best_model_save_path</span><span class="o">=</span><span class="n">eval_env</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">_env_working_dir_parent</span> <span class="o">+</span>
    <span class="s1">&#39;/best_model/&#39;</span><span class="p">,</span>
    <span class="n">log_path</span><span class="o">=</span><span class="n">eval_env</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">_env_working_dir_parent</span> <span class="o">+</span>
    <span class="s1">&#39;/best_model/&#39;</span><span class="p">,</span>
    <span class="n">eval_freq</span><span class="o">=</span><span class="n">n_timesteps_episode</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">deterministic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">render</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">n_eval_episodes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eval_callback</span><span class="p">)</span>

<span class="n">callback</span> <span class="o">=</span> <span class="n">CallbackList</span><span class="p">(</span><span class="n">callbacks</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>In order to track all the training process in <em>wandb</em>, it is necessary to create a callback with a compatible wandb output format (which call <em>wandb</em> log method in the learning algorithm process).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># wandb logger and setting in SB3</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">(</span>
    <span class="n">folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">output_formats</span><span class="o">=</span><span class="p">[</span>
        <span class="n">HumanOutputFormat</span><span class="p">(</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
            <span class="n">max_length</span><span class="o">=</span><span class="mi">120</span><span class="p">),</span>
        <span class="n">WandBOutputFormat</span><span class="p">()])</span>
<span class="n">model</span><span class="o">.</span><span class="n">set_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<span class="c1"># Append callback</span>
<span class="n">log_callback</span> <span class="o">=</span> <span class="n">LoggerCallback</span><span class="p">()</span>
<span class="n">callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_callback</span><span class="p">)</span>


<span class="n">callback</span> <span class="o">=</span> <span class="n">CallbackList</span><span class="p">(</span><span class="n">callbacks</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This is the number of total time steps for the training.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">timesteps</span> <span class="o">=</span> <span class="n">episodes</span> <span class="o">*</span> <span class="n">n_timesteps_episode</span>
</pre></div>
</div>
</div>
<p>Now is time to train the model with the callbacks defined earlier. This may take a few minutes, depending on your computer.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">learn</span><span class="p">(</span>
    <span class="n">total_timesteps</span><span class="o">=</span><span class="n">timesteps</span><span class="p">,</span>
    <span class="n">callback</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
    <span class="n">log_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[2023-04-05 14:51:53,742] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 14:51:53,957] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51-res1/Eplus-env-sub_run1
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/usr/local/lib/python3.10/dist-packages/opyplus/weather_data/weather_data.py:493: FutureWarning: the &#39;line_terminator&#39;&#39; keyword is deprecated, use &#39;lineterminator&#39; instead.
  epw_content = self._headers_to_epw(use_datetimes=use_datetimes) + df.to_csv(
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[2023-04-05 14:52:35,576] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:EnergyPlus episode completed successfully.
[2023-04-05 14:52:35,578] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 14:52:35,781] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51-res1/Eplus-env-sub_run2
------------------------------------------------------------------------------------
| action/                                                             |            |
|    Cooling_Setpoint_RL                                              | 25.5       |
|    Heating_Setpoint_RL                                              | 19.1       |
| action_simulation/                                                  |            |
|    Cooling_Setpoint_RL                                              | 25.5       |
|    Heating_Setpoint_RL                                              | 19.1       |
| episode/                                                            |            |
|    comfort_violation_time(%)                                        | 52.5       |
|    cumulative_comfort_penalty                                       | -2.65e+04  |
|    cumulative_power                                                 | 2.06e+08   |
|    cumulative_power_penalty                                         | -2.06e+04  |
|    cumulative_reward                                                | -23582.973 |
|    ep_length                                                        | 35040      |
|    mean_comfort_penalty                                             | -0.758     |
|    mean_power                                                       | 5.89e+03   |
|    mean_power_penalty                                               | -0.589     |
|    mean_reward                                                      | -0.67303   |
| observation/                                                        |            |
|    Facility Total HVAC Electricity Demand Rate(Whole Building)      | 5.89e+03   |
|    People Air Temperature(SPACE1-1 PEOPLE 1)                        | 21.2       |
|    Site Diffuse Solar Radiation Rate per Area(Environment)          | 73.6       |
|    Site Direct Solar Radiation Rate per Area(Environment)           | 115        |
|    Site Outdoor Air Drybulb Temperature(Environment)                | 11.2       |
|    Site Outdoor Air Relative Humidity(Environment)                  | 71.3       |
|    Site Wind Direction(Environment)                                 | 195        |
|    Site Wind Speed(Environment)                                     | 3.87       |
|    Zone Air Relative Humidity(SPACE1-1)                             | 43         |
|    Zone Air Temperature(SPACE1-1)                                   | 21.2       |
|    Zone People Occupant Count(SPACE1-1)                             | 3.18       |
|    Zone Thermal Comfort Clothing Value(SPACE1-1 PEOPLE 1)           | 0.662      |
|    Zone Thermal Comfort Fanger Model PPD(SPACE1-1 PEOPLE 1)         | 31.7       |
|    Zone Thermal Comfort Mean Radiant Temperature(SPACE1-1 PEOPLE 1) | 21.4       |
|    Zone Thermostat Cooling Setpoint Temperature(SPACE1-1)           | 25.5       |
|    Zone Thermostat Heating Setpoint Temperature(SPACE1-1)           | 19.1       |
|    day                                                              | 15.7       |
|    hour                                                             | 11.5       |
|    month                                                            | 6.53       |
|    year                                                             | 1.99e+03   |
| rollout/                                                            |            |
|    ep_len_mean                                                      | 3.5e+04    |
|    ep_rew_mean                                                      | -2.36e+04  |
|    exploration_rate                                                 | 0.05       |
| time/                                                               |            |
|    episodes                                                         | 1          |
|    fps                                                              | 815        |
|    time_elapsed                                                     | 42         |
|    total_timesteps                                                  | 35040      |
------------------------------------------------------------------------------------
[2023-04-05 14:53:29,396] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:EnergyPlus episode completed successfully.
[2023-04-05 14:53:29,398] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 14:53:29,543] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51-res1/Eplus-env-sub_run3
[2023-04-05 14:53:30,304] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 14:53:30,455] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION-res1/Eplus-env-sub_run1
[2023-04-05 14:54:01,956] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:EnergyPlus episode completed successfully.
[2023-04-05 14:54:01,959] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 14:54:02,117] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION-res1/Eplus-env-sub_run2
Eval num_timesteps=70080, episode_reward=-22366.66 +/- 0.00
Episode length: 35040.00 +/- 0.00
New best mean reward!
-------------------------------------------------------------------------------------
| action/                                                             |             |
|    Cooling_Setpoint_RL                                              | 23.7        |
|    Heating_Setpoint_RL                                              | 20.6        |
| action_simulation/                                                  |             |
|    Cooling_Setpoint_RL                                              | 23.7        |
|    Heating_Setpoint_RL                                              | 20.6        |
| episode/                                                            |             |
|    comfort_violation_time(%)                                        | 47.8        |
|    cumulative_comfort_penalty                                       | -1.95e+04   |
|    cumulative_power                                                 | 2.62e+08    |
|    cumulative_power_penalty                                         | -2.62e+04   |
|    cumulative_reward                                                | -22837.932  |
|    ep_length                                                        | 35040       |
|    mean_comfort_penalty                                             | -0.556      |
|    mean_power                                                       | 7.47e+03    |
|    mean_power_penalty                                               | -0.747      |
|    mean_reward                                                      | -0.65176743 |
| eval/                                                               |             |
|    comfort_penalty                                                  | -1.37e+04   |
|    comfort_violation(%)                                             | 33.4        |
|    mean_ep_length                                                   | 3.5e+04     |
|    mean_power_consumption                                           | 3.1e+08     |
|    mean_rewards                                                     | -22366.656  |
|    power_penalty                                                    | -3.1e+04    |
|    std_rewards                                                      | 0.0         |
| observation/                                                        |             |
|    Facility Total HVAC Electricity Demand Rate(Whole Building)      | 7.47e+03    |
|    People Air Temperature(SPACE1-1 PEOPLE 1)                        | 21.5        |
|    Site Diffuse Solar Radiation Rate per Area(Environment)          | 73.6        |
|    Site Direct Solar Radiation Rate per Area(Environment)           | 115         |
|    Site Outdoor Air Drybulb Temperature(Environment)                | 11.2        |
|    Site Outdoor Air Relative Humidity(Environment)                  | 71.3        |
|    Site Wind Direction(Environment)                                 | 195         |
|    Site Wind Speed(Environment)                                     | 3.87        |
|    Zone Air Relative Humidity(SPACE1-1)                             | 42.1        |
|    Zone Air Temperature(SPACE1-1)                                   | 21.5        |
|    Zone People Occupant Count(SPACE1-1)                             | 3.18        |
|    Zone Thermal Comfort Clothing Value(SPACE1-1 PEOPLE 1)           | 0.662       |
|    Zone Thermal Comfort Fanger Model PPD(SPACE1-1 PEOPLE 1)         | 27          |
|    Zone Thermal Comfort Mean Radiant Temperature(SPACE1-1 PEOPLE 1) | 21.6        |
|    Zone Thermostat Cooling Setpoint Temperature(SPACE1-1)           | 23.7        |
|    Zone Thermostat Heating Setpoint Temperature(SPACE1-1)           | 20.6        |
|    day                                                              | 15.7        |
|    hour                                                             | 11.5        |
|    month                                                            | 6.53        |
|    year                                                             | 1.99e+03    |
| rollout/                                                            |             |
|    ep_len_mean                                                      | 3.5e+04     |
|    ep_rew_mean                                                      | -2.32e+04   |
|    exploration_rate                                                 | 0.05        |
| time/                                                               |             |
|    episodes                                                         | 2           |
|    fps                                                              | 542         |
|    time_elapsed                                                     | 129         |
|    total_timesteps                                                  | 70080       |
| train/                                                              |             |
|    learning_rate                                                    | 0.0001      |
|    loss                                                             | 93.4        |
|    n_updates                                                        | 5019        |
-------------------------------------------------------------------------------------
[2023-04-05 14:55:12,660] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:EnergyPlus episode completed successfully.
[2023-04-05 14:55:12,663] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 14:55:12,822] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51-res1/Eplus-env-sub_run4
------------------------------------------------------------------------------------
| action/                                                             |            |
|    Cooling_Setpoint_RL                                              | 23.3       |
|    Heating_Setpoint_RL                                              | 21         |
| action_simulation/                                                  |            |
|    Cooling_Setpoint_RL                                              | 23.3       |
|    Heating_Setpoint_RL                                              | 21         |
| episode/                                                            |            |
|    comfort_violation_time(%)                                        | 36         |
|    cumulative_comfort_penalty                                       | -1.63e+04  |
|    cumulative_power                                                 | 3.04e+08   |
|    cumulative_power_penalty                                         | -3.04e+04  |
|    cumulative_reward                                                | -23348.816 |
|    ep_length                                                        | 35040      |
|    mean_comfort_penalty                                             | -0.466     |
|    mean_power                                                       | 8.66e+03   |
|    mean_power_penalty                                               | -0.866     |
|    mean_reward                                                      | -0.6663475 |
| observation/                                                        |            |
|    Facility Total HVAC Electricity Demand Rate(Whole Building)      | 8.66e+03   |
|    People Air Temperature(SPACE1-1 PEOPLE 1)                        | 21.9       |
|    Site Diffuse Solar Radiation Rate per Area(Environment)          | 73.6       |
|    Site Direct Solar Radiation Rate per Area(Environment)           | 115        |
|    Site Outdoor Air Drybulb Temperature(Environment)                | 11.2       |
|    Site Outdoor Air Relative Humidity(Environment)                  | 71.3       |
|    Site Wind Direction(Environment)                                 | 195        |
|    Site Wind Speed(Environment)                                     | 3.87       |
|    Zone Air Relative Humidity(SPACE1-1)                             | 41.4       |
|    Zone Air Temperature(SPACE1-1)                                   | 21.9       |
|    Zone People Occupant Count(SPACE1-1)                             | 3.18       |
|    Zone Thermal Comfort Clothing Value(SPACE1-1 PEOPLE 1)           | 0.662      |
|    Zone Thermal Comfort Fanger Model PPD(SPACE1-1 PEOPLE 1)         | 23.5       |
|    Zone Thermal Comfort Mean Radiant Temperature(SPACE1-1 PEOPLE 1) | 21.8       |
|    Zone Thermostat Cooling Setpoint Temperature(SPACE1-1)           | 23.3       |
|    Zone Thermostat Heating Setpoint Temperature(SPACE1-1)           | 21         |
|    day                                                              | 15.7       |
|    hour                                                             | 11.5       |
|    month                                                            | 6.53       |
|    year                                                             | 1.99e+03   |
| rollout/                                                            |            |
|    ep_len_mean                                                      | 3.5e+04    |
|    ep_rew_mean                                                      | -2.33e+04  |
|    exploration_rate                                                 | 0.05       |
| time/                                                               |            |
|    episodes                                                         | 3          |
|    fps                                                              | 526        |
|    time_elapsed                                                     | 199        |
|    total_timesteps                                                  | 105120     |
| train/                                                              |            |
|    learning_rate                                                    | 0.0001     |
|    loss                                                             | 19.8       |
|    n_updates                                                        | 13779      |
------------------------------------------------------------------------------------
[2023-04-05 14:56:23,839] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:EnergyPlus episode completed successfully.
[2023-04-05 14:56:23,840] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 14:56:23,986] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51-res1/Eplus-env-sub_run5
[2023-04-05 14:56:29,946] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:EnergyPlus episode completed successfully.
[2023-04-05 14:56:29,948] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 14:56:30,097] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION-res1/Eplus-env-sub_run3
[2023-04-05 14:57:02,000] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:EnergyPlus episode completed successfully.
[2023-04-05 14:57:02,001] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 14:57:02,153] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION-res1/Eplus-env-sub_run4
Eval num_timesteps=140160, episode_reward=-24046.03 +/- 0.00
Episode length: 35040.00 +/- 0.00
------------------------------------------------------------------------------------
| action/                                                             |            |
|    Cooling_Setpoint_RL                                              | 23.9       |
|    Heating_Setpoint_RL                                              | 20.3       |
| action_simulation/                                                  |            |
|    Cooling_Setpoint_RL                                              | 23.9       |
|    Heating_Setpoint_RL                                              | 20.3       |
| episode/                                                            |            |
|    comfort_violation_time(%)                                        | 35         |
|    cumulative_comfort_penalty                                       | -1.92e+04  |
|    cumulative_power                                                 | 2.9e+08    |
|    cumulative_power_penalty                                         | -2.9e+04   |
|    cumulative_reward                                                | -24122.254 |
|    ep_length                                                        | 35040      |
|    mean_comfort_penalty                                             | -0.548     |
|    mean_power                                                       | 8.29e+03   |
|    mean_power_penalty                                               | -0.829     |
|    mean_reward                                                      | -0.6884205 |
| eval/                                                               |            |
|    comfort_penalty                                                  | -1.85e+04  |
|    comfort_violation(%)                                             | 35.6       |
|    mean_ep_length                                                   | 3.5e+04    |
|    mean_power_consumption                                           | 2.96e+08   |
|    mean_rewards                                                     | -24046.03  |
|    power_penalty                                                    | -2.96e+04  |
|    std_rewards                                                      | 0.0        |
| observation/                                                        |            |
|    Facility Total HVAC Electricity Demand Rate(Whole Building)      | 8.29e+03   |
|    People Air Temperature(SPACE1-1 PEOPLE 1)                        | 21.7       |
|    Site Diffuse Solar Radiation Rate per Area(Environment)          | 73.6       |
|    Site Direct Solar Radiation Rate per Area(Environment)           | 115        |
|    Site Outdoor Air Drybulb Temperature(Environment)                | 11.2       |
|    Site Outdoor Air Relative Humidity(Environment)                  | 71.3       |
|    Site Wind Direction(Environment)                                 | 195        |
|    Site Wind Speed(Environment)                                     | 3.87       |
|    Zone Air Relative Humidity(SPACE1-1)                             | 41.9       |
|    Zone Air Temperature(SPACE1-1)                                   | 21.7       |
|    Zone People Occupant Count(SPACE1-1)                             | 3.18       |
|    Zone Thermal Comfort Clothing Value(SPACE1-1 PEOPLE 1)           | 0.662      |
|    Zone Thermal Comfort Fanger Model PPD(SPACE1-1 PEOPLE 1)         | 25.4       |
|    Zone Thermal Comfort Mean Radiant Temperature(SPACE1-1 PEOPLE 1) | 21.7       |
|    Zone Thermostat Cooling Setpoint Temperature(SPACE1-1)           | 23.9       |
|    Zone Thermostat Heating Setpoint Temperature(SPACE1-1)           | 20.3       |
|    day                                                              | 15.7       |
|    hour                                                             | 11.5       |
|    month                                                            | 6.53       |
|    year                                                             | 1.99e+03   |
| rollout/                                                            |            |
|    ep_len_mean                                                      | 3.5e+04    |
|    ep_rew_mean                                                      | -2.35e+04  |
|    exploration_rate                                                 | 0.05       |
| time/                                                               |            |
|    episodes                                                         | 4          |
|    fps                                                              | 453        |
|    time_elapsed                                                     | 309        |
|    total_timesteps                                                  | 140160     |
| train/                                                              |            |
|    learning_rate                                                    | 0.0001     |
|    loss                                                             | 26.9       |
|    n_updates                                                        | 22539      |
------------------------------------------------------------------------------------
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;stable_baselines3.dqn.dqn.DQN at 0x7f2498717550&gt;
</pre></div></div>
</div>
<p>Now, we save the current model (model version when training has finished).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">_env_working_dir_parent</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">experiment_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>And as always, remember to close the environment.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/usr/local/lib/python3.10/dist-packages/numpy/core/fromnumeric.py:3464: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/usr/local/lib/python3.10/dist-packages/numpy/core/_methods.py:192: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/usr/local/lib/python3.10/dist-packages/numpy/core/_methods.py:269: RuntimeWarning: Degrees of freedom &lt;= 0 for slice
  ret = _var(a, axis=axis, dtype=dtype, out=out, ddof=ddof,
/usr/local/lib/python3.10/dist-packages/numpy/core/_methods.py:226: RuntimeWarning: invalid value encountered in divide
  arrmean = um.true_divide(arrmean, div, out=arrmean,
/usr/local/lib/python3.10/dist-packages/numpy/core/_methods.py:261: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[2023-04-05 15:01:11,136] EPLUS_ENV_SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_MainThread_ROOT INFO:EnergyPlus simulation closed successfully.
</pre></div></div>
</div>
<p>We have to upload all Sinergym output as <em>wandb</em> artifact. This output include all sinergym_output (and LoggerWrapper CSV files) and models generated in training and evaluation episodes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">artifact</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">Artifact</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;training&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;experiment1&quot;</span><span class="p">)</span>
<span class="n">artifact</span><span class="o">.</span><span class="n">add_dir</span><span class="p">(</span>
        <span class="n">env</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">_env_working_dir_parent</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;training_output/&#39;</span><span class="p">)</span>
<span class="n">artifact</span><span class="o">.</span><span class="n">add_dir</span><span class="p">(</span>
    <span class="n">eval_env</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">_env_working_dir_parent</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;evaluation_output/&#39;</span><span class="p">)</span>
<span class="n">run</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span>

<span class="c1"># wandb has finished</span>
<span class="n">run</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-intense-fg ansi-bold">wandb</span>: Adding directory to artifact (/workspaces/sinergym/examples/Eplus-env-SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51-res1)... Done. 0.1s
<span class="ansi-blue-intense-fg ansi-bold">wandb</span>: Adding directory to artifact (/workspaces/sinergym/examples/Eplus-env-SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_EVALUATION-res1)... Done. 0.1s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
Waiting for W&B process to finish... <strong style="color:green">(success).</strong></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
wandb: Network error (TransientError), entering retry loop.
wandb: Network error (TransientError), entering retry loop.
wandb: Network error (TransientError), entering retry loop.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<style>
    table.wandb td:nth-child(1) { padding: 0 10px; text-align: left ; width: auto;} td:nth-child(2) {text-align: left ; width: 100%}
    .wandb-row { display: flex; flex-direction: row; flex-wrap: wrap; justify-content: flex-start; width: 100% }
    .wandb-col { display: flex; flex-direction: column; flex-basis: 100%; flex: 1; padding: 10px; }
    </style>
<div class="wandb-row"><div class="wandb-col"><h3>Run history:</h3><br/><table class="wandb"><tr><td>action/Cooling_Setpoint_RL</td><td>█▂▁▃</td></tr><tr><td>action/Heating_Setpoint_RL</td><td>▁▆█▆</td></tr><tr><td>action_simulation/Cooling_Setpoint_RL</td><td>█▂▁▃</td></tr><tr><td>action_simulation/Heating_Setpoint_RL</td><td>▁▆█▆</td></tr><tr><td>episode/comfort_violation_time(%)</td><td>█▆▁▁</td></tr><tr><td>episode/cumulative_comfort_penalty</td><td>▁▆█▆</td></tr><tr><td>episode/cumulative_power</td><td>▁▅█▇</td></tr><tr><td>episode/cumulative_power_penalty</td><td>█▄▁▂</td></tr><tr><td>episode/cumulative_reward</td><td>▄█▅▁</td></tr><tr><td>episode/ep_length</td><td>▁▁▁▁</td></tr><tr><td>episode/mean_comfort_penalty</td><td>▁▆█▆</td></tr><tr><td>episode/mean_power</td><td>▁▅█▇</td></tr><tr><td>episode/mean_power_penalty</td><td>█▄▁▂</td></tr><tr><td>episode/mean_reward</td><td>▄█▅▁</td></tr><tr><td>eval/comfort_penalty</td><td>█▁</td></tr><tr><td>eval/comfort_violation(%)</td><td>▁█</td></tr><tr><td>eval/mean_ep_length</td><td>▁▁</td></tr><tr><td>eval/mean_power_consumption</td><td>█▁</td></tr><tr><td>eval/mean_rewards</td><td>█▁</td></tr><tr><td>eval/power_penalty</td><td>▁█</td></tr><tr><td>eval/std_rewards</td><td>▁▁</td></tr><tr><td>observation/Facility Total HVAC Electricity Demand Rate(Whole Building)</td><td>▁▅█▇</td></tr><tr><td>observation/People Air Temperature(SPACE1-1 PEOPLE 1)</td><td>▁▄█▆</td></tr><tr><td>observation/Site Diffuse Solar Radiation Rate per Area(Environment)</td><td>▁▁▁▁</td></tr><tr><td>observation/Site Direct Solar Radiation Rate per Area(Environment)</td><td>▁▁▁▁</td></tr><tr><td>observation/Site Outdoor Air Drybulb Temperature(Environment)</td><td>▁▁▁▁</td></tr><tr><td>observation/Site Outdoor Air Relative Humidity(Environment)</td><td>▁▁▁▁</td></tr><tr><td>observation/Site Wind Direction(Environment)</td><td>▁▁▁▁</td></tr><tr><td>observation/Site Wind Speed(Environment)</td><td>▁▁▁▁</td></tr><tr><td>observation/Zone Air Relative Humidity(SPACE1-1)</td><td>█▄▁▃</td></tr><tr><td>observation/Zone Air Temperature(SPACE1-1)</td><td>▁▄█▆</td></tr><tr><td>observation/Zone People Occupant Count(SPACE1-1)</td><td>▁▁▁▁</td></tr><tr><td>observation/Zone Thermal Comfort Clothing Value(SPACE1-1 PEOPLE 1)</td><td>▁▁▁▁</td></tr><tr><td>observation/Zone Thermal Comfort Fanger Model PPD(SPACE1-1 PEOPLE 1)</td><td>█▄▁▃</td></tr><tr><td>observation/Zone Thermal Comfort Mean Radiant Temperature(SPACE1-1 PEOPLE 1)</td><td>▁▄█▆</td></tr><tr><td>observation/Zone Thermostat Cooling Setpoint Temperature(SPACE1-1)</td><td>█▂▁▃</td></tr><tr><td>observation/Zone Thermostat Heating Setpoint Temperature(SPACE1-1)</td><td>▁▆█▆</td></tr><tr><td>observation/day</td><td>▁▁▁▁</td></tr><tr><td>observation/hour</td><td>▁▁▁▁</td></tr><tr><td>observation/month</td><td>▁▁▁▁</td></tr><tr><td>observation/year</td><td>▁▁▁▁</td></tr><tr><td>rollout/ep_len_mean</td><td>▁▁▁▁</td></tr><tr><td>rollout/ep_rew_mean</td><td>▁█▇▃</td></tr><tr><td>rollout/exploration_rate</td><td>▁▁▁▁</td></tr><tr><td>time/episodes</td><td>▁▃▆█</td></tr><tr><td>time/fps</td><td>█▃▂▁</td></tr><tr><td>time/time_elapsed</td><td>▁▃▅█</td></tr><tr><td>time/total_timesteps</td><td>▁▃▆█</td></tr><tr><td>train/learning_rate</td><td>▁▁▁</td></tr><tr><td>train/loss</td><td>█▁▂</td></tr><tr><td>train/n_updates</td><td>▁▅█</td></tr></table><br/></div><div class="wandb-col"><h3>Run summary:</h3><br/><table class="wandb"><tr><td>action/Cooling_Setpoint_RL</td><td>23.92586</td></tr><tr><td>action/Heating_Setpoint_RL</td><td>20.33833</td></tr><tr><td>action_simulation/Cooling_Setpoint_RL</td><td>23.92586</td></tr><tr><td>action_simulation/Heating_Setpoint_RL</td><td>20.33833</td></tr><tr><td>episode/comfort_violation_time(%)</td><td>35.0</td></tr><tr><td>episode/cumulative_comfort_penalty</td><td>-19195.31635</td></tr><tr><td>episode/cumulative_power</td><td>290491842.64102</td></tr><tr><td>episode/cumulative_power_penalty</td><td>-29049.18426</td></tr><tr><td>episode/cumulative_reward</td><td>-24122.25391</td></tr><tr><td>episode/ep_length</td><td>35040</td></tr><tr><td>episode/mean_comfort_penalty</td><td>-0.54781</td></tr><tr><td>episode/mean_power</td><td>8290.29231</td></tr><tr><td>episode/mean_power_penalty</td><td>-0.82903</td></tr><tr><td>episode/mean_reward</td><td>-0.68842</td></tr><tr><td>eval/comfort_penalty</td><td>-18462.58008</td></tr><tr><td>eval/comfort_violation(%)</td><td>35.63356</td></tr><tr><td>eval/mean_ep_length</td><td>35040.0</td></tr><tr><td>eval/mean_power_consumption</td><td>296288163.17097</td></tr><tr><td>eval/mean_rewards</td><td>-24046.0293</td></tr><tr><td>eval/power_penalty</td><td>-29628.81632</td></tr><tr><td>eval/std_rewards</td><td>0.0</td></tr><tr><td>observation/Facility Total HVAC Electricity Demand Rate(Whole Building)</td><td>8290.1535</td></tr><tr><td>observation/People Air Temperature(SPACE1-1 PEOPLE 1)</td><td>21.68222</td></tr><tr><td>observation/Site Diffuse Solar Radiation Rate per Area(Environment)</td><td>73.57191</td></tr><tr><td>observation/Site Direct Solar Radiation Rate per Area(Environment)</td><td>115.15166</td></tr><tr><td>observation/Site Outdoor Air Drybulb Temperature(Environment)</td><td>11.24046</td></tr><tr><td>observation/Site Outdoor Air Relative Humidity(Environment)</td><td>71.29315</td></tr><tr><td>observation/Site Wind Direction(Environment)</td><td>194.72517</td></tr><tr><td>observation/Site Wind Speed(Environment)</td><td>3.86764</td></tr><tr><td>observation/Zone Air Relative Humidity(SPACE1-1)</td><td>41.94364</td></tr><tr><td>observation/Zone Air Temperature(SPACE1-1)</td><td>21.68282</td></tr><tr><td>observation/Zone People Occupant Count(SPACE1-1)</td><td>3.17908</td></tr><tr><td>observation/Zone Thermal Comfort Clothing Value(SPACE1-1 PEOPLE 1)</td><td>0.66228</td></tr><tr><td>observation/Zone Thermal Comfort Fanger Model PPD(SPACE1-1 PEOPLE 1)</td><td>25.36044</td></tr><tr><td>observation/Zone Thermal Comfort Mean Radiant Temperature(SPACE1-1 PEOPLE 1)</td><td>21.71455</td></tr><tr><td>observation/Zone Thermostat Cooling Setpoint Temperature(SPACE1-1)</td><td>23.92591</td></tr><tr><td>observation/Zone Thermostat Heating Setpoint Temperature(SPACE1-1)</td><td>20.3383</td></tr><tr><td>observation/day</td><td>15.72055</td></tr><tr><td>observation/hour</td><td>11.5</td></tr><tr><td>observation/month</td><td>6.52603</td></tr><tr><td>observation/year</td><td>1991.0</td></tr><tr><td>rollout/ep_len_mean</td><td>35040.0</td></tr><tr><td>rollout/ep_rew_mean</td><td>-23472.99229</td></tr><tr><td>rollout/exploration_rate</td><td>0.05</td></tr><tr><td>time/episodes</td><td>4</td></tr><tr><td>time/fps</td><td>453</td></tr><tr><td>time/time_elapsed</td><td>309</td></tr><tr><td>time/total_timesteps</td><td>140160</td></tr><tr><td>train/learning_rate</td><td>0.0001</td></tr><tr><td>train/loss</td><td>26.87911</td></tr><tr><td>train/n_updates</td><td>22539</td></tr></table><br/></div></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
View run <strong style="color:#cdcd00">SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_nt18lsm5</strong> at: <a href='https://wandb.ai/alex_ugr/sinergym/runs/gxs4rau3' target="_blank">https://wandb.ai/alex_ugr/sinergym/runs/gxs4rau3</a><br/>Synced 5 W&B file(s), 0 media file(s), 180 artifact file(s) and 0 other file(s)</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
Find logs at: <code>./wandb/run-20230405_145126-gxs4rau3/logs</code></div>
</div>
<p>We have all the experiments results in our local computer, but we can see the execution in <em>wandb</em> too:</p>
<ul class="simple">
<li><p>If we check our projects, we can see the execution allocated:</p></li>
</ul>
<img alt="wandb_projects1" src="https://github.com/ugr-sail/sinergym/blob/main/images/wandb_projects1.png?raw=true" />
<ul class="simple">
<li><p>Hyperparameters tracked in the training experiment:</p></li>
</ul>
<img alt="wandb_training_hyperparameters" src="https://github.com/ugr-sail/sinergym/blob/main/images/wandb_training_hyperparameters.png?raw=true" />
<ul class="simple">
<li><p>Artifacts registered (if evaluation is enabled, best model is registered too):</p></li>
</ul>
<img alt="wandb_training_artifact" src="https://github.com/ugr-sail/sinergym/blob/main/images/wandb_training_artifact.png?raw=true" />
<ul class="simple">
<li><p>Visualization of metrics in real time:</p></li>
</ul>
<img alt="wandb_training_charts" src="https://github.com/ugr-sail/sinergym/blob/main/images/wandb_training_charts.png?raw=true" />
</section>
<section id="Loading-a-model">
<h2><span class="section-number">21.2. </span>Loading a model<a class="headerlink" href="#Loading-a-model" title="Link to this heading"></a></h2>
<p>We are going to rely on the script available in the repository root called <code class="docutils literal notranslate"><span class="pre">load_agent.py</span></code>. This script applies all the possibilities that Sinergym has to work with deep reinforcement learning models loaded and set parameters to everything so that we can define the load options from the execution of the script easily by a JSON file.</p>
<p>For more information about how run <code class="docutils literal notranslate"><span class="pre">load_agent.py</span></code>, please, see <a class="reference external" href="https://ugr-sail.github.io/sinergym/compilation/main/pages/deep-reinforcement-learning.html#load-a-trained-model">Load a trained model</a>.</p>
<p>First we define the Sinergym environment ID where we want to check the loaded agent and the name of the evaluation experiment.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Environment ID</span>
<span class="n">environment</span> <span class="o">=</span> <span class="s2">&quot;Eplus-demo-v1&quot;</span>
<span class="c1"># Episodes</span>
<span class="n">episodes</span><span class="o">=</span><span class="mi">5</span>
<span class="c1"># Evaluation name</span>
<span class="n">evaluation_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">_%H:%M&#39;</span><span class="p">)</span>
<span class="n">evaluation_name</span> <span class="o">=</span> <span class="s1">&#39;SB3_DQN-EVAL-&#39;</span> <span class="o">+</span> <span class="n">environment</span> <span class="o">+</span> \
    <span class="s1">&#39;-episodes-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">episodes</span><span class="p">)</span>
<span class="n">evaluation_name</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">evaluation_date</span>
</pre></div>
</div>
</div>
<p>We can also use <em>wandb</em> here. We can allocate this evaluation of a loaded model in other project in order to not merge experiments.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1"># Create wandb.config object in order to log all experiment params</span>
<span class="n">experiment_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;sinergym-version&#39;</span><span class="p">:</span> <span class="n">sinergym</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span>
    <span class="s1">&#39;python-version&#39;</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span>
<span class="p">}</span>
<span class="n">experiment_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;environment&#39;</span><span class="p">:</span><span class="n">environment</span><span class="p">,</span>
                          <span class="s1">&#39;episodes&#39;</span><span class="p">:</span><span class="n">episodes</span><span class="p">,</span>
                          <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span><span class="s1">&#39;SB3_DQN&#39;</span><span class="p">})</span>

<span class="c1"># Get wandb init params (you have to specify your own project and entity)</span>
<span class="n">wandb_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="s1">&#39;sinergym_evaluations&#39;</span><span class="p">,</span>
                <span class="s2">&quot;entity&quot;</span><span class="p">:</span> <span class="s1">&#39;alex_ugr&#39;</span><span class="p">}</span>
<span class="c1"># Init wandb entry</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">init</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="n">experiment_name</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">wandb</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">generate_id</span><span class="p">(),</span>
    <span class="n">config</span><span class="o">=</span><span class="n">experiment_params</span><span class="p">,</span>
    <span class="o">**</span> <span class="n">wandb_params</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
Tracking run with wandb version 0.14.0</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
Run data is saved locally in <code>/workspaces/sinergym/examples/wandb/run-20230405_150935-2wfphha2</code></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
Syncing run <strong><a href='https://wandb.ai/alex_ugr/sinergym_evaluations/runs/2wfphha2' target="_blank">SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_1h487a7p</a></strong> to <a href='https://wandb.ai/alex_ugr/sinergym_evaluations' target="_blank">Weights & Biases</a> (<a href='https://wandb.me/run' target="_blank">docs</a>)<br/></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
View project at <a href='https://wandb.ai/alex_ugr/sinergym_evaluations' target="_blank">https://wandb.ai/alex_ugr/sinergym_evaluations</a></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
View run at <a href='https://wandb.ai/alex_ugr/sinergym_evaluations/runs/2wfphha2' target="_blank">https://wandb.ai/alex_ugr/sinergym_evaluations/runs/2wfphha2</a></div>
</div>
<p>We make the gymnasium environment and wrap with LoggerWrapper. We can use the evaluation experiment name to rename the environment.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">=</span><span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">env_name</span><span class="o">=</span><span class="n">evaluation_name</span><span class="p">)</span>
<span class="n">env</span><span class="o">=</span><span class="n">LoggerWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[2023-04-05 15:12:10,652] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:Updating idf ExternalInterface object if it is not present...
[2023-04-05 15:12:10,654] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:Updating idf Site:Location and SizingPeriod:DesignDay(s) to weather and ddy file...
[2023-04-05 15:12:10,659] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:Updating idf OutPut:Variable and variables XML tree model for BVCTB connection.
[2023-04-05 15:12:10,663] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:Setting up extra configuration in building model if exists...
[2023-04-05 15:12:10,664] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:Setting up action definition in building model if exists...
</pre></div></div>
</div>
<p>We load the Stable Baselines 3 DQN model using the model allocated in our local computer, although we can use a remote model allocated in <em>wandb</em> from other training experiment.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get wandb artifact path (to load model)</span>
<span class="n">load_artifact_entity</span> <span class="o">=</span> <span class="s1">&#39;alex_ugr&#39;</span>
<span class="n">load_artifact_project</span> <span class="o">=</span> <span class="s1">&#39;sinergym&#39;</span>
<span class="n">load_artifact_name</span> <span class="o">=</span> <span class="s1">&#39;training&#39;</span>
<span class="n">load_artifact_tag</span> <span class="o">=</span> <span class="s1">&#39;latest&#39;</span>
<span class="n">load_artifact_model_path</span> <span class="o">=</span> <span class="s1">&#39;evaluation_output/best_model/model.zip&#39;</span>
<span class="n">wandb_path</span> <span class="o">=</span> <span class="n">load_artifact_entity</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">load_artifact_project</span> <span class="o">+</span> \
    <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">load_artifact_name</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">load_artifact_tag</span>
<span class="c1"># Download artifact</span>
<span class="n">artifact</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">use_artifact</span><span class="p">(</span><span class="n">wandb_path</span><span class="p">)</span>
<span class="n">artifact</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">load_artifact_model_path</span><span class="p">)</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="c1"># Set model path to local wandb file downloaded</span>
<span class="n">model_path</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span> <span class="o">+</span> <span class="n">load_artifact_model_path</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">DQN</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>As we can see, The <em>wandb</em> model we want to load can come from an artifact of an different entity or project from the one we are using to register the evaluation of the loaded model, as long as it is accessible. The next step is use the model to predict actions and interact with the environment in order to collect data to evaluate the model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">episodes</span><span class="p">):</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="n">rewards</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">terminated</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">current_month</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">terminated</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminated</span><span class="p">,</span> <span class="n">truncated</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">rewards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reward</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">current_month</span><span class="p">:</span>
            <span class="n">current_month</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rewards</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s1">&#39;Episode &#39;</span><span class="p">,</span>
        <span class="n">i</span><span class="p">,</span>
        <span class="s1">&#39;Mean reward: &#39;</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rewards</span><span class="p">),</span>
        <span class="s1">&#39;Cumulative reward: &#39;</span><span class="p">,</span>
        <span class="nb">sum</span><span class="p">(</span><span class="n">rewards</span><span class="p">))</span>
<span class="n">env</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[2023-04-05 15:12:27,791] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 15:12:27,939] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09-res1/Eplus-env-sub_run1
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/usr/local/lib/python3.10/dist-packages/opyplus/weather_data/weather_data.py:493: FutureWarning: the &#39;line_terminator&#39;&#39; keyword is deprecated, use &#39;lineterminator&#39; instead.
  epw_content = self._headers_to_epw(use_datetimes=use_datetimes) + df.to_csv(
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1 -1.086220480544118
2 -2079.9961147920526
3 -4054.5450027104594
4 -5315.115280552358
5 -6240.707702132893
6 -7147.282200268969
7 -9757.11094202821
8 -12816.141002414372
9 -15759.877949459922
10 -18249.178074198662
11 -19008.92750593897
12 -20059.684052467783
1 -22170.235119703077
Episode  0 Mean reward:  -0.6327121894892542 Cumulative reward:  -22170.235119703077
[2023-04-05 15:13:01,011] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:EnergyPlus episode completed successfully.
[2023-04-05 15:13:01,013] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 15:13:01,189] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09-res1/Eplus-env-sub_run2
1 -1.086220480544118
2 -2077.808749644109
3 -4069.9817270164053
4 -5325.590232162119
5 -6251.094400409479
6 -7142.7185322162595
7 -9777.3107632979
8 -12818.25361887402
9 -15762.374127346286
10 -18231.94068105046
11 -18987.961511158555
12 -20041.518570795673
1 -22144.44512276465
Episode  1 Mean reward:  -0.6319761735948897 Cumulative reward:  -22144.44512276465
[2023-04-05 15:13:31,919] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:EnergyPlus episode completed successfully.
[2023-04-05 15:13:31,921] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 15:13:32,073] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09-res1/Eplus-env-sub_run3
1 -1.086220480544118
2 -2074.74448257394
3 -4062.5949917628845
4 -5325.70363538299
5 -6253.469406019579
6 -7148.541871566801
7 -9784.916120573987
8 -12838.678311807513
9 -15794.291411067137
10 -18276.527032414844
11 -19042.489923154084
12 -20085.940757588887
1 -22178.803167409744
Episode  2 Mean reward:  -0.6329567113986868 Cumulative reward:  -22178.803167409744
[2023-04-05 15:14:02,027] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:EnergyPlus episode completed successfully.
[2023-04-05 15:14:02,029] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 15:14:02,171] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09-res1/Eplus-env-sub_run4
1 -1.086220480544118
2 -2082.9054717823406
3 -4074.250922934873
4 -5327.335935890106
5 -6251.275680234238
6 -7147.772973553305
7 -9767.521129024877
8 -12840.88671128354
9 -15811.114469435519
10 -18272.994929371645
11 -19031.05416218702
12 -20078.863700569666
1 -22181.401316477346
Episode  3 Mean reward:  -0.6330308594885183 Cumulative reward:  -22181.401316477346
[2023-04-05 15:14:32,352] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:EnergyPlus episode completed successfully.
[2023-04-05 15:14:32,355] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:Creating new EnergyPlus simulation episode...
[2023-04-05 15:14:32,509] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:EnergyPlus working directory is in /workspaces/sinergym/examples/Eplus-env-SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09-res1/Eplus-env-sub_run5
1 -1.086220480544118
2 -2084.652790803984
3 -4070.5495742366775
4 -5324.967427767579
5 -6250.029044962512
6 -7148.441029556015
7 -9778.087495747093
8 -12814.333239737103
9 -15767.066370294466
10 -18255.85311251997
11 -19016.03275121007
12 -20063.851931359102
1 -22163.97043890765
Episode  4 Mean reward:  -0.6325334029368671 Cumulative reward:  -22163.97043890765
[2023-04-05 15:15:02,528] EPLUS_ENV_SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09_MainThread_ROOT INFO:EnergyPlus simulation closed successfully.
</pre></div></div>
</div>
<p>Finally, we register the evaluation data in wandb as an artifact to save it.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">artifact</span> <span class="o">=</span> <span class="n">wandb</span><span class="o">.</span><span class="n">Artifact</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;evaluating&quot;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;evaluation1&quot;</span><span class="p">)</span>
<span class="n">artifact</span><span class="o">.</span><span class="n">add_dir</span><span class="p">(</span>
    <span class="n">env</span><span class="o">.</span><span class="n">simulator</span><span class="o">.</span><span class="n">_env_working_dir_parent</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;evaluation_output/&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="o">.</span><span class="n">log_artifact</span><span class="p">(</span><span class="n">artifact</span><span class="p">)</span>

<span class="c1"># wandb has finished</span>
<span class="n">run</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-intense-fg ansi-bold">wandb</span>: Adding directory to artifact (/workspaces/sinergym/examples/Eplus-env-SB3_DQN-EVAL-Eplus-demo-v1-episodes-5_2023-04-05_15:09-res1)... Done. 0.1s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
Waiting for W&B process to finish... <strong style="color:green">(success).</strong></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
View run <strong style="color:#cdcd00">SB3_DQN-Eplus-demo-v1-episodes-4_2023-04-05_14:51_1h487a7p</strong> at: <a href='https://wandb.ai/alex_ugr/sinergym_evaluations/runs/2wfphha2' target="_blank">https://wandb.ai/alex_ugr/sinergym_evaluations/runs/2wfphha2</a><br/>Synced 5 W&B file(s), 0 media file(s), 101 artifact file(s) and 0 other file(s)</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
Find logs at: <code>./wandb/run-20230405_150935-2wfphha2/logs</code></div>
</div>
<p>We have the loaded model results in our local computer, but we can see the execution in <em>wandb</em> too:</p>
<ul class="simple">
<li><p>If we check the wandb project list, we can see that sinergym_evaluations project has a new run:</p></li>
</ul>
<img alt="wandb_project2" src="https://github.com/ugr-sail/sinergym/blob/main/images/wandb_project2.png?raw=true" />
<ul class="simple">
<li><p>Hyperparameters tracked in the evaluation experiment and we can see the previous training artifact used to load the model:</p></li>
</ul>
<img alt="wandb_evaluating_hyperparameters" src="https://github.com/ugr-sail/sinergym/blob/main/images/wandb_evaluating_hyperparameters.png?raw=true" />
<ul class="simple">
<li><p>Artifact registered with Sinergym Output (and CSV files generated with the Logger Wrapper):</p></li>
</ul>
<img alt="wandb_evaluating_artifact" src="https://github.com/ugr-sail/sinergym/blob/main/images/wandb_evaluating_artifact.png?raw=true" />
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="rule_controller_example.html" class="btn btn-neutral float-left" title="20. Rule Controller example" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../API-reference.html" class="btn btn-neutral float-right" title="API reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, J. Jiménez, J. Gómez, M. Molina, A. Manjavacas, A. Campoy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: v2.3.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../../../v1.4.0/index.html">v1.4.0</a></dd>
            <dd><a href="../../../v1.6.0/index.html">v1.6.0</a></dd>
            <dd><a href="../../../v1.7.0/index.html">v1.7.0</a></dd>
            <dd><a href="../../../v2.0.0/index.html">v2.0.0</a></dd>
            <dd><a href="../../../v2.1.0/index.html">v2.1.0</a></dd>
            <dd><a href="../../../v2.2.0/index.html">v2.2.0</a></dd>
            <dd><a href="drl.html">v2.3.0</a></dd>
            <dd><a href="../../../v2.5.0/index.html">v2.5.0</a></dd>
            <dd><a href="../../../v3.1.0/index.html">v3.1.0</a></dd>
            <dd><a href="../../../v3.2.0/index.html">v3.2.0</a></dd>
            <dd><a href="../../../v3.3.0/index.html">v3.3.0</a></dd>
            <dd><a href="../../../v3.4.0/index.html">v3.4.0</a></dd>
            <dd><a href="../../../v3.5.0/index.html">v3.5.0</a></dd>
            <dd><a href="../../../v3.6.0/index.html">v3.6.0</a></dd>
            <dd><a href="../../../v3.7.0/index.html">v3.7.0</a></dd>
            <dd><a href="../../../v3.8.0/index.html">v3.8.0</a></dd>
            <dd><a href="../../../v3.9.0/index.html">v3.9.0</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../../main/index.html">main</a></dd>
        </dl>
    </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

<style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search,
    .wy-nav-top {
        background: #a5beba;
    }

    /* Sidebar */
    .wy-nav-side {
        background: #2b3435;
    }
</style>


</body>
</html>