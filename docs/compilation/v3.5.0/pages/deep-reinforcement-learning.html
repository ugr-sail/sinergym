<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>14. Deep Reinforcement Learning Integration &mdash; Sinergym  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/doc_theme.css?v=642ef2a8" />

  
    <link rel="shortcut icon" href="../_static/logo-sidebar.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="15. Sinergym with Google Cloud" href="gcloudAPI.html" />
    <link rel="prev" title="13. Extra Configuration in Sinergym simulations" href="extra-configuration.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #a5beba" >

          
          
          <a href="../index.html" class="icon icon-home">
            Sinergym
              <img src="../_static/logo-sidebar.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Start Here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">1. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage-example.html">2. Usage Example</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">sinergym</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="buildings.html">3. Buildings</a></li>
<li class="toctree-l1"><a class="reference internal" href="weathers.html">4. Weathers</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">5. Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="environments.html">6. Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="environments_registration.html">7. Environments Configuration and Registration</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">8. Logging System Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="output.html">9. Output format</a></li>
<li class="toctree-l1"><a class="reference internal" href="rewards.html">10. Rewards</a></li>
<li class="toctree-l1"><a class="reference internal" href="controllers.html">11. Controllers</a></li>
<li class="toctree-l1"><a class="reference internal" href="wrappers.html">12. Wrappers</a></li>
<li class="toctree-l1"><a class="reference internal" href="extra-configuration.html">13. Extra Configuration in Sinergym simulations</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">14. Deep Reinforcement Learning Integration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#evaluation-callback">14.1. Evaluation Callback</a></li>
<li class="toctree-l2"><a class="reference internal" href="#usage">14.2. Usage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#model-training">14.2.1. Model Training</a></li>
<li class="toctree-l3"><a class="reference internal" href="#model-loading">14.2.2. Model Loading</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="gcloudAPI.html">15. Sinergym with Google Cloud</a></li>
<li class="toctree-l1"><a class="reference internal" href="github-actions.html">16. Github Actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="tests.html">17. Tests</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="notebooks/basic_example.html">18. Basic example</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks/getting_env_information.html">19. Getting information about Sinergym environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks/change_environment.html">20. Changing an environment registered in Sinergym</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks/default_building_control.html">21. Default building control setting up an empty action interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks/wrappers_examples.html">22. Wrappers example</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks/personalize_loggerwrapper.html">23. Logger Wrapper personalization/configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks/logging_unused_variables.html">24. Logging unused variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks/rule_controller_example.html">25. Rule Controller example</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks/drl.html">26. DRL usage example</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="API-reference.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #a5beba" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sinergym</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">14. </span>Deep Reinforcement Learning Integration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/pages/deep-reinforcement-learning.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="deep-reinforcement-learning-integration">
<h1><span class="section-number">14. </span>Deep Reinforcement Learning Integration<a class="headerlink" href="#deep-reinforcement-learning-integration" title="Link to this heading"></a></h1>
<p><em>Sinergym</em> provides features to utilize <strong>Deep Reinforcement Learning algorithms</strong> from
<a class="reference external" href="https://stable-baselines3.readthedocs.io/en/master/">Stable Baselines 3</a>. However,
<em>Sinergym</em> is also compatible with any algorithm that operates with the Gymnasium interface.</p>
<p>To this end, we will refine and develop
<a class="reference external" href="https://stable-baselines3.readthedocs.io/en/master/guide/callbacks.html">Callbacks</a>,
a set of functions that will be called at specific <strong>stages of the training procedure</strong>.
Callbacks allow you to access the internal state of the RL model <strong>during training</strong>.
They enable monitoring, auto-saving, model manipulation, progress bars, and more.
Our callbacks inherit from Stable Baselines 3 and can be found in
<a class="reference external" href="https://github.com/ugr-sail/sinergym/blob/main/sinergym/utils/callbacks.py">sinergym/sinergym/utils/callbacks.py</a>.</p>
<section id="evaluation-callback">
<h2><span class="section-number">14.1. </span>Evaluation Callback<a class="headerlink" href="#evaluation-callback" title="Link to this heading"></a></h2>
<p>An enhanced callback, named <code class="docutils literal notranslate"><span class="pre">LoggerEvalCallback</span></code>, is used for evaluating the model versions obtained during
the training process with <em>Sinergym</em>. It stores the best model obtained, not necessarily the final one from
the training process. This callback inherits from Stable Baselines 3’s <code class="docutils literal notranslate"><span class="pre">EventCallback</span></code>.</p>
<p>This callback functions similarly to EvalCallback from Stable Baselines 3 but includes numerous enhancements
and specific adaptations for <em>Sinergym</em> and for logging relevant information during the process.</p>
<p>It requires that the evaluation environment be previously wrapped by a child class of <code class="docutils literal notranslate"><span class="pre">BaseLoggerWrapper</span></code>. This is
essential for the callback to access the logger’s methods and attributes and to log information correctly.</p>
<p>Additionally, this callback saves the best model and evaluation summaries (CSV file) in a folder named <code class="docutils literal notranslate"><span class="pre">evaluation</span></code>
within the training environment’s output.</p>
<p>To log all this data to the Weights and Biases platform, the training environment must be previously wrapped
with the <code class="docutils literal notranslate"><span class="pre">WandbLoggerWrapper</span></code> class (see <a class="reference internal" href="wrappers.html#logger-wrappers"><span class="std std-ref">Logger Wrappers</span></a>). This allows evaluation data to be recorded on
the Weights and Biases platform. Encapsulating the evaluation environment is not necessary unless detailed
monitoring of these episodes is desired.</p>
<p>The data logged on the platform, in the Evaluations section, will depend on the specific logger wrapper used
and its episode summary. Thus, to obtain new metrics, the logger wrapper must be modified, not the callback.</p>
<p>The number of episodes run in each evaluation and their frequency can be configured, and metrics from the
underlying logger can be excluded if desired. Moreover, if normalization in observation space is applied,
the callback <strong>will automatically copy the calibration parameters</strong> from the training environment to the evaluation
environment.</p>
<p>More episodes lead to more accurate averages of the reward-based indicators, providing a more realistic
assessment of the current model’s performance. However, this increases the time required. To see an example,
visit <a class="reference internal" href="notebooks/drl.html#Training-a-model"><span class="std std-ref">Training a model</span></a>.</p>
</section>
<section id="usage">
<h2><span class="section-number">14.2. </span>Usage<a class="headerlink" href="#usage" title="Link to this heading"></a></h2>
<section id="model-training">
<h3><span class="section-number">14.2.1. </span>Model Training<a class="headerlink" href="#model-training" title="Link to this heading"></a></h3>
<p>Leverage this functionality for your experiments using the script
<a class="reference external" href="https://github.com/ugr-sail/sinergym/blob/main/scripts/train/train_agent.py">sinergym/scripts/train/train_agent.py</a>.</p>
<p>Key considerations for your experiments:</p>
<ul class="simple">
<li><p>Models are built using an algorithm constructor, each with its own <strong>specific parameters</strong>.
Defaults are used if none are defined.</p></li>
<li><p>If you normalize the environment wrapper, models will <strong>train</strong> in these <strong>normalized</strong> spaces.</p></li>
<li><p><strong>Concatenate</strong> callbacks in a <code class="docutils literal notranslate"><span class="pre">CallbackList</span></code> instance from Stable Baselines 3.</p></li>
<li><p>The neural network begins training upon executing the <code class="docutils literal notranslate"><span class="pre">model.learn()</span></code> method, where you specify <code class="docutils literal notranslate"><span class="pre">timesteps</span></code>,
<code class="docutils literal notranslate"><span class="pre">callbacks</span></code>, and <code class="docutils literal notranslate"><span class="pre">log_interval</span></code>.</p></li>
<li><p><strong>Curriculum Learning</strong> can be implemented by adding a model field with a valid model path.
The script will load and train the model.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">train_agent.py</span></code> script requires a single parameter, <code class="docutils literal notranslate"><span class="pre">-conf</span></code>, a string indicating the JSON
file containing all experiment details. Refer to the JSON structure in <a class="reference external" href="https://github.com/ugr-sail/sinergym/blob/main/scripts/train/train_agent_PPO.json">sinergym/scripts/train/train_agent_PPO.json</a>:</p>
<ul class="simple">
<li><p><strong>Mandatory</strong> parameters: environment, episodes, algorithm (and any non-default algorithm parameters).</p></li>
<li><p><strong>Optional</strong> parameters: environment parameters (overwrites default if specified), seed, pre-training
model to load, experiment ID, wrappers (in order), training evaluation, and cloud options.</p></li>
<li><p>Field names must match the example, or the experiment will fail.</p></li>
</ul>
<p>The script performs the following:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Names the experiment in the format: <code class="docutils literal notranslate"><span class="pre">&lt;algorithm&gt;-&lt;environment_name&gt;-episodes&lt;episodes_int&gt;-seed&lt;seed_value&gt;(&lt;experiment_date&gt;)</span></code></p></li>
<li><p>Sets environment parameters if specified.</p></li>
<li><p>Applies specified wrappers from JSON.</p></li>
<li><p>Save all experiment’s hyperparameters in WandB if a session is detected.</p></li>
<li><p>Defines model algorithm with specified hyperparameters.</p></li>
<li><p>Calculates training timesteps from number of episodes.</p></li>
<li><p>Sets up evaluation callback if specified.</p></li>
<li><p>Trains with environment.</p></li>
<li><p>If remote store is specified, saves all outputs in Google Cloud Bucket. If wandb is specified, saves all outputs in wandb run artifact.</p></li>
<li><p>Auto-deletes remote container in Google Cloud Platform if auto-delete parameter is specified.</p></li>
</ol>
</div></blockquote>
</section>
<section id="model-loading">
<h3><span class="section-number">14.2.2. </span>Model Loading<a class="headerlink" href="#model-loading" title="Link to this heading"></a></h3>
<p>Use the script <a class="reference external" href="https://github.com/ugr-sail/sinergym/blob/main/scripts/eval/load_agent.py">sinergym/scripts/eval/load_agent.py</a>
to load and evaluate or execute a previously trained model.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">load_agent.py</span></code> script requires a single parameter, <code class="docutils literal notranslate"><span class="pre">-conf</span></code>, a string indicating the JSON file
containing all evaluation details. Refer to the JSON structure in
<a class="reference external" href="https://github.com/ugr-sail/sinergym/blob/main/scripts/eval/load_agent_example.json">sinergym/scripts/eval/load_agent_example.json</a>:</p>
<ul class="simple">
<li><p><strong>Mandatory</strong> parameters: environment, episodes, algorithm (name only), and model to load: local (<code class="docutils literal notranslate"><span class="pre">model</span></code>) or remote (<code class="docutils literal notranslate"><span class="pre">wandb_model</span></code>).</p></li>
<li><p><strong>Optional</strong> parameters: environment parameters (overwrites default if specified), experiment ID,
wrappers (in order), and cloud options.</p></li>
</ul>
<p>The script loads the model and predicts actions from states over the specified episodes. The information
is collected and sent to remote storage (like WandB) if specified, otherwise it remains in local memory.</p>
<p>The model field in JSON can be a <strong>local path</strong> to the model, a <strong>bucket url</strong> in the form
<code class="docutils literal notranslate"><span class="pre">gs://</span></code>, or a <em>wandb</em> artifact path for stored models.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>This project is a work in progress. Direct support for additional algorithms is planned for the future!</em></p>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="extra-configuration.html" class="btn btn-neutral float-left" title="13. Extra Configuration in Sinergym simulations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="gcloudAPI.html" class="btn btn-neutral float-right" title="15. Sinergym with Google Cloud" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, J. Jiménez, J. Gómez, M. Molina, A. Manjavacas, A. Campoy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
        <span class="fa fa-book"> Other Versions</span>
        v: v3.5.0
        <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
        <dl>
            <dt>Tags</dt>
            <dd><a href="../../v1.4.0/pages/deep-reinforcement-learning.html">v1.4.0</a></dd>
            <dd><a href="../../v1.6.0/pages/deep-reinforcement-learning.html">v1.6.0</a></dd>
            <dd><a href="../../v1.7.0/pages/deep-reinforcement-learning.html">v1.7.0</a></dd>
            <dd><a href="../../v2.0.0/pages/deep-reinforcement-learning.html">v2.0.0</a></dd>
            <dd><a href="../../v2.1.0/pages/deep-reinforcement-learning.html">v2.1.0</a></dd>
            <dd><a href="../../v2.2.0/pages/deep-reinforcement-learning.html">v2.2.0</a></dd>
            <dd><a href="../../v2.3.0/pages/deep-reinforcement-learning.html">v2.3.0</a></dd>
            <dd><a href="../../v2.5.0/pages/deep-reinforcement-learning.html">v2.5.0</a></dd>
            <dd><a href="../../v3.1.0/pages/deep-reinforcement-learning.html">v3.1.0</a></dd>
            <dd><a href="../../v3.2.0/pages/deep-reinforcement-learning.html">v3.2.0</a></dd>
            <dd><a href="../../v3.3.0/pages/deep-reinforcement-learning.html">v3.3.0</a></dd>
            <dd><a href="../../v3.4.0/pages/deep-reinforcement-learning.html">v3.4.0</a></dd>
            <dd><a href="deep-reinforcement-learning.html">v3.5.0</a></dd>
            <dd><a href="../../v3.6.0/pages/deep-reinforcement-learning.html">v3.6.0</a></dd>
            <dd><a href="../../v3.7.0/pages/deep-reinforcement-learning.html">v3.7.0</a></dd>
        </dl>
        <dl>
            <dt>Branches</dt>
            <dd><a href="../../main/pages/deep-reinforcement-learning.html">main</a></dd>
        </dl>
    </div>
</div><script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

<style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search,
    .wy-nav-top {
        background: #a5beba;
    }

    /* Sidebar */
    .wy-nav-side {
        background: #2b3435;
    }
</style>


</body>
</html>